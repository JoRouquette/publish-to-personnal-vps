/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var oe=Object.defineProperty;var Ce=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var Re=Object.prototype.hasOwnProperty;var ke=(s,e)=>{for(var t in e)oe(s,t,{get:e[t],enumerable:!0})},Ne=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of xe(e))!Re.call(s,i)&&i!==t&&oe(s,i,{get:()=>e[i],enumerable:!(n=Ce(e,i))||n.enumerable});return s};var Ve=s=>Ne(oe({},"__esModule",{value:!0}),s);var et={};ke(et,{default:()=>se});module.exports=Ve(et);var b=require("obsidian");var de={plugin:{name:"Publish To Personal VPS",commandPublish:"Launch publishing to Personal VPS",commandTestConnection:"Test VPS connection",commandOpenSettings:"Open Publish To Personal VPS Settings",publishSuccess:"Publishing completed.",publishError:"Error during publishing (see console).",noConfig:"No VPS or folder configuration defined.",error:{failureToExportSettings:"Failed to export settings."}},settings:{tabTitle:"Publish To Personal VPS",errors:{missingVpsConfig:"VPS configuration not found for folder: "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"draft",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"Language selection",label:"Language",description:"Choose plugin language."},vps:{title:"VPS configuration",nameLabel:"Name",nameDescription:"Internal name for this VPS.",urlLabel:"URL",urlDescription:"Example: https://notes.mydomain.com",apiKeyLabel:"API key",apiKeyDescription:"Key used to authenticate uploads.",help:"HTTP requests to /api/upload will use this URL and API key."},folders:{title:"Folders to publish",addButton:"Add folder",deleteButton:"Delete folder",deleteLastForbidden:"At least one folder is required.",vaultLabel:"Vault folder",vaultDescription:"Example: Blog, Notes/Docs, etc.",routeLabel:"Site route",routeDescription:"Example: /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Remove fenced code blocks",sanitizeRemoveCodeBlocksDescription:"If enabled, fenced code blocks (``` or ~~~) will be removed from the content before publishing.",rulesHelp:"Notes whose frontmatter matches the ignore rules below will not be published."},ignoreRules:{title:"Ignore rules",description:"Notes with these frontmatter properties will be ignored during publishing.",help:"You can define global rules based on frontmatter properties and values.",addButton:"Add ignore rule",deleteButton:"Delete ignore rule",propertyLabel:"Frontmatter property",propertyDescription:"Property to inspect in the frontmatter.",valueLabel:"Value(s) to ignore",valueDescription:"Comma-separated list of values to ignore for this property.",modeValues:"Ignore specific values",modeBoolean:"Ignore if equal (true/false)"},testConnection:{label:"Test connection",notImplemented:"Connection test not implemented yet.",failed:"Connection test failed.",success:"Connection test succeeded.",invalidConfig:"Invalid VPS configuration.",invalidJson:"Invalid JSON response.",missingApiKey:"Missing API key.",invalidUrl:"Invalid URL.",resultPrefix:"Test connection result: ",unexpectedResponsePrefix:"Unexpected response from server: "}}},ge={plugin:{name:"Publier vers mon VPS personnel",commandPublish:"Publier vers mon VPS personnel",commandTestConnection:"Tester la connexion VPS",commandOpenSettings:"Ouvrir les param\xE8tres du plugin Publier vers mon VPS personnel",publishSuccess:"Publication termin\xE9e.",publishError:"Erreur lors de la publication (voir la console).",noConfig:"Aucune configuration VPS ou dossier d\xE9finie.",error:{failureToExportSettings:"\xC9chec de l\u2019exportation des param\xE8tres."}},settings:{tabTitle:"Publier vers mon VPS personnel",errors:{missingVpsConfig:"Configuration VPS introuvable pour le dossier : "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"brouillon",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"S\xE9lection de la langue",label:"Langue",description:"Choisir la langue du plugin."},vps:{title:"Configuration du VPS",nameLabel:"Nom",nameDescription:"Nom interne pour ce VPS.",urlLabel:"URL",urlDescription:"Ex : https://notes.mondomaine.fr",apiKeyLabel:"Cl\xE9 API",apiKeyDescription:"Cl\xE9 utilis\xE9e pour authentifier les envois.",help:"Les requ\xEAtes HTTP vers /api/upload utiliseront cette URL et cette cl\xE9."},folders:{title:"Dossiers \xE0 publier",addButton:"Ajouter un dossier",deleteButton:"Supprimer le dossier",deleteLastForbidden:"Au moins un dossier est requis.",vaultLabel:"Dossier du vault",vaultDescription:"Ex : Blog, Notes/Docs, etc.",routeLabel:"Route du site",routeDescription:"Ex : /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Supprimer les blocs de code d\xE9limit\xE9s",sanitizeRemoveCodeBlocksDescription:"Si activ\xE9, les blocs de code d\xE9limit\xE9s (``` ou ~~~) seront supprim\xE9s du contenu avant publication.",rulesHelp:"Les notes dont le frontmatter correspond aux r\xE8gles ci-dessous ne seront pas publi\xE9es."},ignoreRules:{title:"R\xE8gles d\u2019ignorance",description:"Les notes avec ces propri\xE9t\xE9s de frontmatter seront ignor\xE9es lors de la publication.",help:"Vous pouvez d\xE9finir des r\xE8gles globales bas\xE9es sur les propri\xE9t\xE9s et valeurs du frontmatter.",addButton:"Ajouter une r\xE8gle d'ignorance",deleteButton:"Supprimer la r\xE8gle d'ignorance",propertyLabel:"Propri\xE9t\xE9 du frontmatter",propertyDescription:"Propri\xE9t\xE9 \xE0 inspecter dans le frontmatter.",valueLabel:"Valeur(s) \xE0 ignorer",valueDescription:"Liste de valeurs \xE0 ignorer pour cette propri\xE9t\xE9 (s\xE9par\xE9es par des virgules).",modeValues:"Ignorer des valeurs sp\xE9cifiques",modeBoolean:"Ignorer si \xE9gal (true/false)"},testConnection:{label:"Tester la connexion",notImplemented:"Test de connexion non impl\xE9ment\xE9 pour l\u2019instant.",failed:"\xC9chec du test de connexion.",success:"Test de connexion r\xE9ussi.",invalidConfig:"Configuration VPS invalide.",invalidJson:"R\xE9ponse JSON invalide.",missingApiKey:"Cl\xE9 API manquante.",invalidUrl:"URL invalide.",resultPrefix:"R\xE9sultat du test de connexion : ",unexpectedResponsePrefix:"R\xE9ponse inattendue du serveur : "}}};function Fe(s){let e=navigator.language||navigator.userLanguage||"en";return String(e).toLowerCase().startsWith("fr")?"fr":"en"}function B(s,e){let t;return!e||e.locale==="system"||!e.locale?t=Fe(s):t=e.locale,{locale:t,t:t==="fr"?ge:de}}var re="enc:";function fe(s){if(!s)return"";try{return re+btoa(s)}catch(e){return s}}function me(s){if(!s)return"";if(!s.startsWith(re))return s;let e=s.slice(re.length);try{return atob(e)}catch(t){return""}}var z=class{generateGuid(){let e=Math.random().toString(36).substring(2,10),t=Date.now().toString(36);return`${e}-${t}`}};var E=require("obsidian"),$=class{constructor(){this.notice=null;this.total=0;this.current=0;this.lastPct=-1}start(e){this.total=Math.max(1,e),this.current=0,this.notice=new E.Notice(this.format(),0),this.update()}advance(e=1){this.current=Math.min(this.total,this.current+e),this.update()}finish(){var e,t;try{(t=(e=this.notice)==null?void 0:e.hide)==null||t.call(e)}catch(n){}this.notice=null,this.total>0&&this.current===this.total?new E.Notice("\u2705 Upload completed"):new E.Notice("\u26A0\uFE0F Upload ended prematurely")}format(){let e=Math.floor(this.current/this.total*100);return`Uploading notes\u2026 ${this.current}/${this.total} (${e}%)`}update(){let e=Math.floor(this.current/this.total*100);if(e===this.lastPct&&this.current!==this.total)return;this.lastPct=e;let t=this.format(),n=this.notice;n&&typeof n.setMessage=="function"?n.setMessage(t):new E.Notice(t,1500)}};var W=require("obsidian"),j=class{constructor(e){this.app=e}async collectNotesFromFolder(e){var o;let t=[],n=(o=e.vaultFolder)==null?void 0:o.trim();if(!n)return{notes:t};let i=this.app.vault.getAbstractFileByPath(n);if(!i)return{notes:t};let r=async a=>{var u;if(a instanceof W.TFolder)for(let c of a.children)await r(c);else if(a instanceof W.TFile){if((a.extension||"").toLowerCase()!=="md")return;let c=await this.app.vault.read(a),g=this.app.metadataCache.getFileCache(a),f=(u=g==null?void 0:g.frontmatter)!=null?u:{};t.push({vaultPath:a.path,relativePath:this.computeRelative(a.path,n),content:c,frontmatter:f})}};return await r(i),{notes:t}}computeRelative(e,t){if(!t)return e;if(e.startsWith(t)){let n=e.slice(t.length);return n=n.replace(/^\/+/,""),n.length>0?n:""}return e}};async function he(s){var r;let e=((r=s.url)!=null?r:"").trim();if(!e)return"invalid-url";if(!s.apiKey)return"missing-api-key";let t=`${e.replace(/\/$/,"")}/api/ping`,n=await fetch(t,{method:"GET",headers:{"x-api-key":s.apiKey}});if(!n.ok)return`HTTP ${n.status}`;let i=null;try{i=await n.json()}catch(o){return"invalid-json"}return!i||i.ok!==!0?"unexpected-response":"success"}var S=require("obsidian");function ae(s,e={}){return{...{id:`folder-${Date.now()}`,vaultFolder:"",routeBase:"",vpsId:s,sanitization:{removeFencedCodeBlocks:!0}},...e}}var K=require("obsidian"),O=class extends K.AbstractInputSuggest{constructor(t,n){super(t,n);this.inputEl=n}getSuggestions(t){let n=t.toLowerCase(),i=[];return this.app.vault.getAllLoadedFiles().forEach(r=>{r instanceof K.TFolder&&(!n||r.path.toLowerCase().contains(n))&&i.push(r)}),i}renderSuggestion(t,n){n.setText(t.path)}selectSuggestion(t){this.inputEl.value=t.path,this.inputEl.dispatchEvent(new Event("input")),this.close()}};var U=class extends S.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var V,F,D,le,ue;let{containerEl:e}=this;e.empty();let{t}=B(this.app,this.plugin.settings),n=this.plugin.settings,i=e.createDiv({cls:"publish-to-personal-vps-settings"});i.createEl("h1",{text:t.settings.tabTitle});let o=i.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});o.createEl("h6",{text:t.settings.language.title}),new S.Setting(o).setName(t.settings.language.label).setDesc(t.settings.language.description).addDropdown(p=>{var y;p.addOption("system","System / Syst\xE8me").addOption("en","English").addOption("fr","Fran\xE7ais").setValue((y=n.locale)!=null?y:"system").onChange(async v=>{n.locale=v,await this.plugin.saveSettings(),this.display()})});let a=(V=n.vpsConfigs)==null?void 0:V[0];a||(a={id:"default",name:"VPS",url:"",apiKey:""},n.vpsConfigs=[a]);let u=i.createDiv({cls:"ptpv-block"}),c=u.createDiv({cls:"ptpv-block-title"});c.createEl("h6",{text:t.settings.vps.title}),new S.Setting(c).setName(t.settings.vps.nameLabel).setDesc(t.settings.vps.nameDescription).addText(p=>p.setPlaceholder("VPS").setValue(a.name).onChange(async y=>{a.name=y.trim(),await this.plugin.saveSettings()})),new S.Setting(u).setName(t.settings.vps.urlLabel).setDesc(t.settings.vps.urlDescription).addText(p=>p.setPlaceholder("https://...").setValue(a.url).onChange(async y=>{a.url=y.trim(),await this.plugin.saveSettings()})),new S.Setting(u).setName(t.settings.vps.apiKeyLabel).setDesc(t.settings.vps.apiKeyDescription).addText(p=>p.setPlaceholder("********").setValue(a.apiKey).onChange(async y=>{a.apiKey=y.trim(),await this.plugin.saveSettings()})),u.createDiv({cls:"ptpv-help",text:t.settings.vps.help});let g=i.createDiv({cls:"ptpv-block"});g.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.ignoreRules.title}),((F=n.ignoreRules)!=null?F:[]).forEach((p,y)=>{var ie;let v=new S.Setting(g).setName(`${(ie=t.settings.ignoreRules.valueLabel)!=null?ie:"Ignore rule"} #${y+1}`);v.addText(R=>{var w;return R.setPlaceholder("frontmatter property").setValue((w=p.property)!=null?w:"").onChange(async C=>{p.property=C.trim(),await this.plugin.saveSettings()})});let L=p.ignoreValues&&p.ignoreValues.length>0?"values":"boolean";v.addDropdown(R=>{var w,C;return R.addOption("boolean",(w=t.settings.ignoreRules.modeBoolean)!=null?w:"Ignore if equals").addOption("values",(C=t.settings.ignoreRules.modeValues)!=null?C:"Ignore specific values").setValue(L).onChange(async A=>{A==="boolean"?(p.ignoreValues=void 0,typeof p.ignoreIf!="boolean"&&(p.ignoreIf=!0)):(p.ignoreIf=void 0,p.ignoreValues||(p.ignoreValues=["draft"])),await this.plugin.saveSettings(),this.display()})}),L==="boolean"?v.addDropdown(R=>R.addOption("true","true").addOption("false","false").setValue(p.ignoreIf===!1?"false":"true").onChange(async w=>{p.ignoreIf=w==="true",await this.plugin.saveSettings()})):v.addText(R=>{var w;return R.setPlaceholder("val1, val2, val3").setValue(((w=p.ignoreValues)!=null?w:[]).join(", ")).onChange(async C=>{p.ignoreValues=C.split(",").map(A=>A.trim()).filter(A=>A.length>0),await this.plugin.saveSettings()})}),v.addExtraButton(R=>{var w;return R.setIcon("trash").setTooltip((w=t.settings.ignoreRules.deleteButton)!=null?w:"Delete ignore rule").onClick(async()=>{var C;(C=n.ignoreRules)==null||C.splice(y,1),await this.plugin.saveSettings(),this.display()})})});let m=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(D=t.settings.ignoreRules.addButton)!=null?D:"Add ignore rule"});m.addClass("mod-cta"),m.onclick=async()=>{var y;let p=(y=n.ignoreRules)!=null?y:[];p.push({property:"publish",ignoreIf:!1}),n.ignoreRules=p,await this.plugin.saveSettings(),this.display()};let h=i.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});h.createEl("h6",{text:t.settings.folders.title}),Array.isArray(n.folders)||(n.folders=[]),n.folders.length===0&&n.folders.push(ae(a.id)),n.folders.forEach((p,y)=>{var C;let v=h.createEl("fieldset",{cls:"ptpv-folder"});v.createEl("legend",{text:p.vaultFolder&&p.vaultFolder.length>0?p.vaultFolder:`${t.settings.folders.vaultLabel} #${y+1}`}),new S.Setting(v).setName((C=t.settings.folders.deleteButton)!=null?C:"Delete folder").addButton(A=>{A.setIcon("trash").onClick(async()=>{var k;if(this.plugin.settings.folders.length<=1){new S.Notice((k=t.settings.folders.deleteLastForbidden)!=null?k:"At least one folder is required.");return}this.plugin.settings.folders.splice(y,1),await this.plugin.saveSettings(),this.display()})}),new S.Setting(v).setName(t.settings.folders.vaultLabel).setDesc(t.settings.folders.vaultDescription).addText(A=>{A.setPlaceholder("Blog").setValue(p.vaultFolder).onChange(async k=>{p.vaultFolder=k.trim(),await this.plugin.saveSettings()}),new O(this.app,A.inputEl)}),new S.Setting(v).setName(t.settings.folders.routeLabel).setDesc(t.settings.folders.routeDescription).addText(A=>A.setPlaceholder("/blog").setValue(p.routeBase).onChange(async k=>{p.routeBase=k.trim(),await this.plugin.saveSettings()})),new S.Setting(v).setName(t.settings.folders.sanitizeRemoveCodeBlocksLabel).setDesc(t.settings.folders.sanitizeRemoveCodeBlocksDescription).addToggle(A=>{var k,pe;return A.setValue((pe=(k=p.sanitization)==null?void 0:k.removeFencedCodeBlocks)!=null?pe:!0).onChange(async ce=>{p.sanitization?p.sanitization.removeFencedCodeBlocks=ce:p.sanitization={removeFencedCodeBlocks:ce},await this.plugin.saveSettings()})})});let x=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(le=t.settings.folders.addButton)!=null?le:"Add folder"});x.addClass("mod-cta"),x.onclick=async()=>{var y,v,L;let p=(L=(v=(y=n.vpsConfigs)==null?void 0:y[0])==null?void 0:v.id)!=null?L:"default";this.plugin.settings.folders.push(ae(p)),await this.plugin.saveSettings(),this.display()};let N=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(ue=t.settings.testConnection.label)!=null?ue:"Test connection"});N.addClass("mod-cta"),N.onclick=async()=>{try{await this.plugin.testConnection()}catch(p){console.error("[PublishToPersonalVps] Connection test failed",p)}}}};var Ie=/```[\s\S]*?```|~~~[\s\S]*?~~~/g,M=class{execute(e,t){if(!t)return{markdown:e,appliedRules:[]};let n=e,i=[];if(t.removeFencedCodeBlocks){let r=n;n=n.replace(Ie,""),r!==n&&i.push("removeFencedCodeBlocks")}return{markdown:n,appliedRules:i}}};var G=class{constructor(){this.sanitizeMarkdown=new M}sanitizeNote(e,t){if(!t)return e;let{markdown:n}=this.sanitizeMarkdown.execute(e.content,t);return{...e,content:n}}};function be(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s{2,}/g," ").trim().toLowerCase().replace(/\s/g,"-")}function Te(s){if(!s)return"";let e=s.trim();return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}function De(s){return s.replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}var H=class{execute(e){let t=Te(e.folderConfig.routeBase||""),i=De(e.relativePath).split("/").filter(Boolean),r;if(i.length===0){let o="note";r={id:o,slug:o,path:"",routeBase:t,fullPath:t?`${t}/${o}`:`/${o}`}}else{let o=i[i.length-1],a=i.slice(0,-1),u=o.replace(/\.[^/.]+$/,""),c=be(u),f=a.map(be).filter(Boolean).join("/"),d=f?`${f}/${c}`:c,l=[t||""];f&&l.push(f),l.push(c);let m=l.filter(Boolean).join("/").replace(/\/{2,}/g,"/");r={id:d,slug:c,path:f,routeBase:t,fullPath:m}}return{...e,routing:r}}};var Le=/!\[\[([^\]]+)\]\]/g;function Be(s){let e=s.toLowerCase();return e.match(/\.(png|jpe?g|gif|webp|svg)$/)?"image":e.match(/\.(mp3|wav|flac|ogg)$/)?"audio":e.match(/\.(mp4|webm|mkv|mov)$/)?"video":e.match(/\.pdf$/)?"pdf":"other"}function Ee(s){let e=s.toLowerCase();if(e==="left")return"left";if(e==="right")return"right";if(e==="center"||e==="centre")return"center"}function $e(s){let e,t,n=[],i=[];for(let r of s){let o=r.trim();if(o){if(i.push(o),!e){let a=Ee(o);if(a){e=a;continue}}if(!t&&/^[0-9]+$/.test(o)){t=parseInt(o,10);continue}n.push(o)}}return{alignment:e,width:t,classes:n,rawModifiers:i}}var J=class{execute(e){let t=e.content,n=[],i;for(;(i=Le.exec(t))!==null;){let r=i[0],o=i[1].trim();if(!o)continue;let a=o.split("|").map(d=>d.trim()).filter(Boolean);if(a.length===0)continue;let u=a[0],c=a.slice(1),g=Be(u),f=$e(c);g==="other"&&!u.includes(".")||n.push({raw:r,target:u,kind:g,display:f})}return n.length===0?e:{...e,assets:n}}};var ze=/\[\[([^\]]+)\]\]/g;function je(s){return s.toLowerCase().match(/\.(png|jpe?g|gif|webp|svg|mp3|wav|flac|ogg|mp4|webm|mkv|mov|pdf|md|markdown)$/)?"file":"note"}function ye(s,e){let t=s.indexOf(e);return t===-1?[s,void 0]:[s.slice(0,t),s.slice(t+e.length)]}var q=class{execute(e){var r;let t=e.content,n=[],i;for(;(i=ze.exec(t))!==null;){let o=i[0],a=i[1].trim();if(!a)continue;let u=(r=i.index)!=null?r:0;if(u>0&&t[u-1]==="!")continue;let[c,g]=ye(a,"|"),f=c.trim(),d=g&&g.trim().length>0?g.trim():void 0;if(!f)continue;let[l,m]=ye(f,"#"),P=l.trim(),h=m&&m.trim().length>0?m.trim():void 0;if(!P)continue;let I=je(P),x={raw:o,target:f,path:P,subpath:h,alias:d,kind:I};n.push(x)}return n.length===0?e:{...e,wikilinks:n}}};function We(s,e){if(!e.includes("."))return s[e];let t=e.split("."),n=s;for(let i of t){if(typeof n!="object"||n===null)return;n=n[i]}return n}function ve(s,e){return s===e}function Oe(s,e){if(e.length!==0){if(Array.isArray(s)){for(let t of s)for(let n of e)if(ve(t,n))return n;return}for(let t of e)if(ve(s,t))return t}}var _=class{execute(e){let{frontmatter:t,rules:n}=e;if(!n||n.length===0)return{isPublishable:!0};let i=t.nested;for(let r=0;r<n.length;r++){let o=n[r],a=We(i,o.property);if(a!==void 0){if(o.ignoreIf!==void 0&&typeof a=="boolean"&&a===o.ignoreIf)return{isPublishable:!1,ignoredByRule:{property:o.property,reason:"ignoreIf",matchedValue:o.ignoreIf,ruleIndex:r}};if(o.ignoreValues&&o.ignoreValues.length>0){let u=Oe(a,o.ignoreValues);if(u!==void 0)return{isPublishable:!1,ignoredByRule:{property:o.property,reason:"ignoreValues",matchedValue:u,ruleIndex:r}}}}}return{isPublishable:!0}}};function Ke(s,e,t){let n=e.split("."),i=s;for(let r=0;r<n.length;r++){let o=n[r];if(r===n.length-1){i[o]=t;return}(typeof i[o]!="object"||i[o]===null)&&(i[o]={}),i=i[o]}}var X=class{execute(e){let t=e.raw?{...e.raw}:{},n={};for(let[i,r]of Object.entries(t))i.includes(".")?Ke(n,i,r):n[i]=r;return{flat:t,nested:n}}};var Ue=/`([^`]*?)`/g;function Me(s,e){let t=e.split(".").filter(Boolean),n=s.nested;for(let i of t){if(n==null||typeof n!="object")return;n=n[i]}return n}function Ge(s){return s==null?"":Array.isArray(s)?s.map(e=>String(e)).join(", "):String(s)}var Y=class{execute(e){let{content:t,frontmatter:n}=e,i=[],r=t.replace(Ue,(o,a)=>{let u=a,c=u.trim();if(!c.startsWith("="))return o;let g=c.slice(1).trim(),f="this.";if(!g.startsWith(f))return o;let d=g.slice(f.length).trim();if(!d)return o;let l=Me(n,d),m=Ge(l);return i.push({raw:o,code:u,expression:g,propertyPath:d,resolvedValue:l,renderedText:m}),m});return{...e,content:r}}};var Z=class{constructor(e,t,n,i=new G){this.vaultPort=e;this.uploaderPort=t;this.guidGenerator=n;this.contentSanitizer=i;this.normalizeFrontmatter=new X;this.evaluateIgnoreRules=new _;this.renderInlineDataview=new Y;this.detectAssets=new J;this.detectWikilinks=new q;this.computeRouting=new H}async execute(e,t){var c,g,f,d;if(!((c=e==null?void 0:e.vpsConfigs)!=null&&c.length)||!((g=e==null?void 0:e.folders)!=null&&g.length))return{type:"noConfig"};let n=new Map;for(let l of e.vpsConfigs)l&&l.id&&n.set(l.id,l);let i=[],r=[];for(let l of e.folders){let m=n.get(l.vpsId);if(!m){i.push(l.id);continue}let{notes:P}=await this.vaultPort.collectNotesFromFolder(l);for(let h of P)r.push({vaultPath:h.vaultPath,relativePath:h.relativePath,content:h.content,frontmatter:(f=h.frontmatter)!=null?f:{},folder:l,vpsConfig:m})}if(i.length>0)return{type:"missingVpsConfig",foldersWithoutVps:i};if(r.length===0)return t==null||t.start(0),t==null||t.finish(),{type:"success",publishedCount:0,notes:[]};t==null||t.start(r.length);let o=[];for(let l of r){let m=this.normalizeFrontmatter.execute({raw:l.frontmatter});if(!this.evaluateIgnoreRules.execute({frontmatter:m,rules:(d=e.ignoreRules)!=null?d:null}).isPublishable){t==null||t.advance(1);continue}let h={noteId:this.guidGenerator.generateGuid(),vaultPath:l.vaultPath,relativePath:l.relativePath,content:l.content,frontmatter:m,folderConfig:l.folder,vpsConfig:l.vpsConfig};h=this.renderInlineDataview.execute(h),h=this.contentSanitizer.sanitizeNote(h,l.folder.sanitization),h=this.detectAssets.execute(h),h=this.detectWikilinks.execute(h),h=this.computeRouting.execute(h),o.push(h),t==null||t.advance(1)}if(o.length===0)return t==null||t.finish(),{type:"success",publishedCount:0,notes:[]};let a=new Map;for(let l of o){let m=l.vpsConfig.id,P=a.get(m);P?P.push(l):a.set(m,[l])}let u=0;try{for(let l of a.values())await this.uploaderPort.upload(l),u+=l.length;return t==null||t.finish(),{type:"success",publishedCount:u,notes:o}}catch(l){return t==null||t.finish(),{type:"error",error:l}}}};function He(s){return s.assets!==void 0}function Pe(s){return s.filter(He)}var Q=class{constructor(e,t){this.assetsVaultPort=e;this.assetsUploaderPort=t}async execute(e){var f;let{notes:t,assetsFolder:n,enableAssetsVaultFallback:i,progress:r}=e,o=[],a=[],u=t.filter(d=>Array.isArray(d.assets)&&d.assets.length>0);if(u.length===0)return{type:"noAssets"};let c=0;for(let d of u)for(let l of(f=d.assets)!=null?f:[])try{let m=await this.assetsVaultPort.resolveAssetForNote(d,l,n,i);o.push({noteId:d.noteId,asset:l,resolved:m}),c+=1}catch(m){a.push({noteId:d.noteId,asset:l,reason:"resolve-error",error:m})}if(o.length===0&&a.length>0)return{type:"success",publishedAssetsCount:0,failures:a};r==null||r.start(c);let g=0;try{for(let d of o){if(!d.resolved){a.push({noteId:d.noteId,asset:d.asset,reason:"not-found"}),r==null||r.advance(1);continue}try{await this.assetsUploaderPort.upload([d.resolved]),g+=1}catch(l){a.push({noteId:d.noteId,asset:d.asset,reason:"upload-error",error:l})}r==null||r.advance(1)}return r==null||r.finish(),{type:"success",publishedAssetsCount:g,failures:a}}catch(d){return r==null||r.finish(),{type:"error",error:d}}}};var ee=class{constructor(e){this.app=e}async resolveAssetForNote(e,t,n,i){var d;let r=Je(n),o=this.extractLinkTarget(t);if(!o)return console.warn("[ObsidianAssetsVaultAdapter] Unable to extract link target from asset",t),null;let a=this.app.vault.getFiles(),u=(d=o.split("/").pop())!=null?d:o,c;if(r&&(c=a.find(l=>qe(l.path,r)?l.path.endsWith("/"+o)||l.path===o?!0:l.name===u:!1)),!c&&i&&(c=a.find(l=>l.path.endsWith("/"+o)||l.path===o?!0:l.name===u)),!c)return console.warn("[ObsidianAssetsVaultAdapter] Asset not found in vault",o,"for note",e.vaultPath),null;let g=_e(c.path,r);return{vaultPath:c.path,fileName:c.name,relativeAssetPath:g}}extractLinkTarget(e){let t=e;if(typeof t.fileName=="string"&&t.fileName.trim())return t.fileName.trim();if(typeof t.target=="string"&&t.target.trim())return t.target.trim();if(typeof t.linkText=="string"&&t.linkText.trim())return t.linkText.trim();if(typeof t.raw=="string"){let n=t.raw,i=n.match(/!\[\[([^\]]+)\]\]/),r=(i?i[1]:n).trim();return r&&r.split("|")[0].trim()||null}return null}};function Je(s){if(!s)return"";let e=s.trim().replace(/\\/g,"/");return e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e}function qe(s,e){if(!e)return!1;let t=s.replace(/\\/g,"/");return t===e||t.startsWith(e+"/")}function _e(s,e){let t=s.replace(/\\/g,"/");return e?t===e?"":t.startsWith(e+"/")?t.slice(e.length+1):t:t}var we=require("obsidian"),te=class{constructor(e){this.vpsConfig=e}async upload(e){var u;if(!Array.isArray(e)||e.length===0)return;let t=(u=e[0].vpsConfig)!=null?u:this.vpsConfig,n=t.apiKey,r={assets:await Promise.all(e.map(async c=>await this.buildApiAsset(c)))},o=await(0,we.requestUrl)({url:t.url.replace(/\/$/,"")+"/api/upload-assets",method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify(r)});if(o.status<200||o.status>=300)throw new Error(`Asset upload failed with status ${o.status}: ${o.text}`);let a=o.json;if(!a||a.ok!==!0)throw new Error(`Upload API returned an error: ${JSON.stringify(a)}`)}async buildApiAsset(e){var t;return{relativePath:e.relativeAssetPath,vaultPath:e.vaultPath,fileName:e.fileName,mimeType:(t=e.mimeType)!=null?t:this.guessMimeType(e.fileName),contentBase64:await this.toBase64(e.content)}}async toBase64(e){if(e instanceof ArrayBuffer)return Buffer.from(e).toString("base64");if(e instanceof Uint8Array)return Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64");throw new Error("Unsupported asset content type")}guessMimeType(e){var n;switch((n=e.split(".").pop())==null?void 0:n.toLowerCase()){case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"gif":return"image/gif";case"svg":return"image/svg+xml";case"webp":return"image/webp";case"pdf":return"application/pdf";default:return"application/octet-stream"}}};var Ae=require("obsidian"),ne=class{constructor(e){this.vpsConfig=e}async upload(e){var u;if(!Array.isArray(e)||e.length===0)return;let t=(u=e[0].vpsConfig)!=null?u:this.vpsConfig,n=t.apiKey,r={notes:e.map(c=>this.buildApiNote(c))},o=await(0,Ae.requestUrl)({url:t.url.replace(/\/$/,"")+"/api/upload",method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify(r)});if(o.status<200||o.status>=300)throw new Error(`Upload failed with status ${o.status}: ${o.text}`);let a=o.json;if(!a||a.ok!==!0)throw new Error(`Upload API returned an error: ${JSON.stringify(a)}`)}buildApiNote(e){var g,f,d,l,m,P,h,I,x,T,N,V,F;let t=(g=e.frontmatter)!=null?g:{},n=(d=(f=t.slug)!=null?f:t.title)!=null?d:this.extractFileNameWithoutExt(e.vaultPath),i=this.slugify(n),r=((m=(l=e.folderConfig)==null?void 0:l.routeBase)!=null?m:"").replace(/\/+$/,""),o=`${r||""}/${e.relativePath}/${i}`.replace(/\/{2,}/g,"/");o.startsWith("/")||(o=`/${o}`);let a=new Date().toISOString(),u=(h=(P=this.toIsoString(t.publishedAt))!=null?P:this.toIsoString(t.date))!=null?h:a,c=(I=this.toIsoString(t.updatedAt))!=null?I:u;return{id:(T=(x=e.relativePath)!=null?x:e.vaultPath)!=null?T:o,slug:i,route:o,relativePath:e.relativePath,vaultPath:e.vaultPath,markdown:e.content,frontmatter:{title:(N=t.title)!=null?N:n,description:(V=t.description)!=null?V:"",date:(F=this.toIsoString(t.date))!=null?F:u,tags:this.toStringArray(t.tags)},publishedAt:u,updatedAt:c}}extractFileNameWithoutExt(e){var n;return((n=e.split("/").pop())!=null?n:e).replace(/\.[^/.]+$/,"")}slugify(e){return e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").trim()}toIsoString(e){if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e.toISOString();if(typeof e=="string"){let t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()}if(typeof e.toISOString=="function")try{let t=e.toISOString(),n=new Date(t);return isNaN(n.getTime())?null:n.toISOString()}catch(t){return null}return null}toStringArray(e){return e?Array.isArray(e)?e.map(t=>typeof t=="string"?t:String(t)).map(t=>t.trim()).filter(Boolean):typeof e=="string"?e.split(",").map(t=>t.trim()).filter(Boolean):[]:[]}};var Xe={vpsConfigs:[],folders:[],ignoreRules:[],locale:"system",assetsFolder:"assets",assetsRoute:"/assets/",enableAssetsVaultFallback:!0};function Se(s){return JSON.parse(JSON.stringify(s))}function Ye(s){let e=Se(s);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:fe(t.apiKey)}))),e}function Ze(s){let e=Se(s);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:me(t.apiKey)}))),e}function Qe(s){let{vpsConfigs:e,folders:t,ignoreRules:n}=s;return{vpsConfigs:e,folders:t,ignoreRules:n}}var se=class extends b.Plugin{async onload(){await this.loadSettings();let{t:e}=B(this.app,this.settings);this.addSettingTab(new U(this.app,this)),this.addCommand({id:"publish-to-personal-vps",name:e.plugin.commandPublish,callback:()=>this.publishToSite()}),this.addCommand({id:"test-vps-connection",name:e.plugin.commandTestConnection,callback:()=>this.testConnection()}),this.addCommand({id:"open-vps-settings",name:e.plugin.commandOpenSettings,callback:()=>{this.app.setting.open(),this.app.setting.openTabById(`${this.manifest.id}`)}}),this.addRibbonIcon("rocket",e.plugin.commandPublish,async()=>{try{await this.publishToSite()}catch(t){console.error("[PublishToPersonalVps] Publish failed from ribbon",t),new b.Notice(e.plugin.publishError)}})}async loadSettings(){var i;let e=(i=await this.loadData())!=null?i:{},t=null;try{let r=this.app.vault.adapter,a=`${`.obsidian/plugins/${this.manifest.id}`}/settings.json`;if(await r.exists(a)){let u=await r.read(a);t=JSON.parse(u)}}catch(r){console.warn("[PublishToPersonalVps] Failed to read settings.json snapshot",r)}let n={...Xe,...e,...t};this.settings=Ze(n)}async saveSettings(){let e=Ye(this.settings);await this.saveData(e)}async publishToSite(){var T,N,V;let e=this.settings,{t}=B(this.app,this.settings);if(!e.vpsConfigs||e.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new b.Notice((N=(T=t.settings.errors)==null?void 0:T.missingVpsConfig)!=null?N:"No VPS configured");return}if(!e.folders||e.folders.length===0){console.warn("[PublishToPersonalVps] No folders configured"),new b.Notice("\u26A0\uFE0F No folders configured for publishing.");return}let n=new j(this.app),i=new z,r=e.vpsConfigs[0],o=new ne(r),a=new Z(n,o,i),u=new $,c=Qe(e),g=await a.execute(c,u);if(g.type==="noConfig"){new b.Notice("\u26A0\uFE0F No folders or VPS configured.");return}if(g.type==="missingVpsConfig"){console.warn("[PublishToPersonalVps] Missing VPS for folders:",g.foldersWithoutVps),new b.Notice("\u26A0\uFE0F Some folder(s) have no VPS configured (see console).");return}if(g.type==="error"){console.error(g.error),new b.Notice("\u274C Error during publishing (see console).");return}let f=g.publishedCount,d=(V=g.notes)!=null?V:[];if(f===0){new b.Notice("\u2705 Nothing to publish (0 note).");return}let l=Pe(d);if(l.length===0){new b.Notice(`\u2705 Published ${f} note(s). No assets to publish.`);return}let m=new ee(this.app),P=new te(r),h=new Q(m,P),I=new $,x=await h.execute({notes:l,assetsFolder:e.assetsFolder,enableAssetsVaultFallback:e.enableAssetsVaultFallback,progress:I});switch(x.type){case"noAssets":{new b.Notice(`\u2705 Published ${f} note(s). No assets to publish.`);break}case"error":{console.error("[PublishToPersonalVps] Error while publishing assets:",x.error),new b.Notice(`\u2705 Published ${f} note(s), but assets publication failed (see console).`);break}case"success":{let{publishedAssetsCount:F,failures:D}=x;D.length>0?(console.warn("[PublishToPersonalVps] Some assets failed to publish:",D),new b.Notice(`\u2705 Published ${f} note(s) and ${F} asset(s), with ${D.length} asset failure(s) (see console).`)):new b.Notice(`\u2705 Published ${f} note(s) and ${F} asset(s).`);break}}}async testConnection(){let{t:e}=B(this.app,this.settings),t=this.settings;if(!(t!=null&&t.vpsConfigs)||t.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new b.Notice(e.settings.errors.missingVpsConfig);return}let n=t.vpsConfigs[0],i=await he(n);switch(i){case"success":new b.Notice(e.settings.testConnection.success);break;case"failure":new b.Notice(e.settings.testConnection.failed);break;case"unexpected-response":new b.Notice(e.settings.testConnection.unexpectedResponsePrefix+i);break;case"invalid-json":new b.Notice(e.settings.testConnection.invalidJson);break;case"missing-api-key":new b.Notice(e.settings.testConnection.missingApiKey);break;case"invalid-url":new b.Notice(e.settings.testConnection.invalidUrl);break;default:new b.Notice(e.settings.testConnection.resultPrefix+i);break}}};
