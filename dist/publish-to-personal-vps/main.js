/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var re=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var De=Object.getOwnPropertyNames;var Ie=Object.prototype.hasOwnProperty;var Le=(n,e)=>{for(var t in e)re(n,t,{get:e[t],enumerable:!0})},Ee=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of De(e))!Ie.call(n,i)&&i!==t&&re(n,i,{get:()=>e[i],enumerable:!(s=Ne(e,i))||s.enumerable});return n};var Be=n=>Ee(re({},"__esModule",{value:!0}),n);var lt={};Le(lt,{default:()=>ie});module.exports=Be(lt);var y=require("obsidian");var ye={plugin:{name:"Publish To Personal VPS",commandPublish:"Launch publishing to Personal VPS",commandTestConnection:"Test VPS connection",commandOpenSettings:"Open Publish To Personal VPS Settings",publishSuccess:"Publishing completed.",publishError:"Error during publishing (see console).",noConfig:"No VPS or folder configuration defined.",error:{failureToExportSettings:"Failed to export settings."}},settings:{tabTitle:"Publish To Personal VPS",errors:{missingVpsConfig:"VPS configuration not found for folder: "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"draft",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"Language selection",label:"Language",description:"Choose plugin language."},vps:{title:"VPS configuration",nameLabel:"Name",nameDescription:"Internal name for this VPS.",urlLabel:"URL",urlDescription:"Example: https://notes.mydomain.com",apiKeyLabel:"API key",apiKeyDescription:"Key used to authenticate uploads.",help:"HTTP requests to /api/upload will use this URL and API key."},folders:{title:"Folders to publish",addButton:"Add folder",deleteButton:"Delete folder",deleteLastForbidden:"At least one folder is required.",vaultLabel:"Vault folder",vaultDescription:"Example: Blog, Notes/Docs, etc.",routeLabel:"Site route",routeDescription:"Example: /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Remove fenced code blocks",sanitizeRemoveCodeBlocksDescription:"If enabled, fenced code blocks (``` or ~~~) will be removed from the content before publishing.",rulesHelp:"Notes whose frontmatter matches the ignore rules below will not be published."},ignoreRules:{title:"Ignore rules",description:"Notes with these frontmatter properties will be ignored during publishing.",help:"You can define global rules based on frontmatter properties and values.",addButton:"Add ignore rule",deleteButton:"Delete ignore rule",propertyLabel:"Frontmatter property",propertyDescription:"Property to inspect in the frontmatter.",valueLabel:"Value(s) to ignore",valueDescription:"Comma-separated list of values to ignore for this property.",modeValues:"Ignore specific values",modeBoolean:"Ignore if equal (true/false)"},testConnection:{label:"Test connection",notImplemented:"Connection test not implemented yet.",failed:"Connection test failed.",success:"Connection test succeeded.",invalidConfig:"Invalid VPS configuration.",invalidJson:"Invalid JSON response.",missingApiKey:"Missing API key.",invalidUrl:"Invalid URL.",resultPrefix:"Test connection result: ",unexpectedResponsePrefix:"Unexpected response from server: "},vault:{title:"Vault & assets",help:"Global settings related to the vault: assets folder and fallback.",assetsFolderLabel:"Assets folder in vault",assetsFolderDescription:"Folder in the vault where assets (images, files) are located. Example: Assets, Media, etc.",enableAssetsVaultFallbackLabel:"Allow system to fallback on vault root",enableAssetsVaultFallbackDescription:"If enabled, when an asset is not found in the specified folder, the system will look for it in the vault root and in all folders."}}},ve={plugin:{name:"Publier vers mon VPS personnel",commandPublish:"Publier vers mon VPS personnel",commandTestConnection:"Tester la connexion VPS",commandOpenSettings:"Ouvrir les param\xE8tres du plugin Publier vers mon VPS personnel",publishSuccess:"Publication termin\xE9e.",publishError:"Erreur lors de la publication (voir la console).",noConfig:"Aucune configuration VPS ou dossier d\xE9finie.",error:{failureToExportSettings:"\xC9chec de l\u2019exportation des param\xE8tres."}},settings:{tabTitle:"Publier vers mon VPS personnel",errors:{missingVpsConfig:"Configuration VPS introuvable pour le dossier : "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"brouillon",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"S\xE9lection de la langue",label:"Langue",description:"Choisir la langue du plugin."},vps:{title:"Configuration du VPS",nameLabel:"Nom",nameDescription:"Nom interne pour ce VPS.",urlLabel:"URL",urlDescription:"Ex : https://notes.mondomaine.fr",apiKeyLabel:"Cl\xE9 API",apiKeyDescription:"Cl\xE9 utilis\xE9e pour authentifier les envois.",help:"Les requ\xEAtes HTTP vers /api/upload utiliseront cette URL et cette cl\xE9."},folders:{title:"Dossiers \xE0 publier",addButton:"Ajouter un dossier",deleteButton:"Supprimer le dossier",deleteLastForbidden:"Au moins un dossier est requis.",vaultLabel:"Dossier du vault",vaultDescription:"Ex : Blog, Notes/Docs, etc.",routeLabel:"Route du site",routeDescription:"Ex : /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Supprimer les blocs de code d\xE9limit\xE9s",sanitizeRemoveCodeBlocksDescription:"Si activ\xE9, les blocs de code d\xE9limit\xE9s (``` ou ~~~) seront supprim\xE9s du contenu avant publication.",rulesHelp:"Les notes dont le frontmatter correspond aux r\xE8gles ci-dessous ne seront pas publi\xE9es."},ignoreRules:{title:"R\xE8gles d\u2019ignorance",description:"Les notes avec ces propri\xE9t\xE9s de frontmatter seront ignor\xE9es lors de la publication.",help:"Vous pouvez d\xE9finir des r\xE8gles globales bas\xE9es sur les propri\xE9t\xE9s et valeurs du frontmatter.",addButton:"Ajouter une r\xE8gle d'ignorance",deleteButton:"Supprimer la r\xE8gle d'ignorance",propertyLabel:"Propri\xE9t\xE9 du frontmatter",propertyDescription:"Propri\xE9t\xE9 \xE0 inspecter dans le frontmatter.",valueLabel:"Valeur(s) \xE0 ignorer",valueDescription:"Liste de valeurs \xE0 ignorer pour cette propri\xE9t\xE9 (s\xE9par\xE9es par des virgules).",modeValues:"Ignorer des valeurs sp\xE9cifiques",modeBoolean:"Ignorer si \xE9gal (true/false)"},testConnection:{label:"Tester la connexion",notImplemented:"Test de connexion non impl\xE9ment\xE9 pour l\u2019instant.",failed:"\xC9chec du test de connexion.",success:"Test de connexion r\xE9ussi.",invalidConfig:"Configuration VPS invalide.",invalidJson:"R\xE9ponse JSON invalide.",missingApiKey:"Cl\xE9 API manquante.",invalidUrl:"URL invalide.",resultPrefix:"R\xE9sultat du test de connexion : ",unexpectedResponsePrefix:"R\xE9ponse inattendue du serveur : "},vault:{title:"Vault & assets",help:"R\xE9glages globaux li\xE9s au vault : dossier d\u2019assets et fallback.",assetsFolderLabel:"Dossier d\u2019assets dans le vault",assetsFolderDescription:"Dossier dans le vault o\xF9 les assets (images, fichiers) sont situ\xE9s. Ex : Assets, Media, etc.",enableAssetsVaultFallbackLabel:"Permettre le recours \xE0 la racine du vault",enableAssetsVaultFallbackDescription:"Si activ\xE9, lorsqu\u2019un asset n\u2019est pas trouv\xE9 dans le dossier sp\xE9cifi\xE9, le syst\xE8me le cherchera \xE0 la racine du vault et dans tous les dossiers."}}};function ze(n){let e=navigator.language||navigator.userLanguage||"en";return String(e).toLowerCase().startsWith("fr")?"fr":"en"}function B(n,e){let t;return!e||e.locale==="system"||!e.locale?t=ze(n):t=e.locale,{locale:t,t:t==="fr"?ve:ye}}var ae="enc:";function Pe(n){if(!n)return"";try{return ae+btoa(n)}catch(e){return n}}function we(n){if(!n)return"";if(!n.startsWith(ae))return n;let e=n.slice(ae.length);try{return atob(e)}catch(t){return""}}var j=class{generateGuid(){let e=Math.random().toString(36).substring(2,10),t=Date.now().toString(36);return`${e}-${t}`}};var z=require("obsidian"),$=class{constructor(){this.notice=null;this.total=0;this.current=0;this.lastPct=-1}start(e){this.total=Math.max(1,e),this.current=0,this.notice=new z.Notice(this.format(),0),this.update()}advance(e=1){this.current=Math.min(this.total,this.current+e),this.update()}finish(){var e,t;try{(t=(e=this.notice)==null?void 0:e.hide)==null||t.call(e)}catch(s){}this.notice=null,this.total>0&&this.current===this.total?new z.Notice("\u2705 Upload completed"):new z.Notice("\u26A0\uFE0F Upload ended prematurely")}format(){let e=Math.floor(this.current/this.total*100);return`Uploading notes\u2026 ${this.current}/${this.total} (${e}%)`}update(){let e=Math.floor(this.current/this.total*100);if(e===this.lastPct&&this.current!==this.total)return;this.lastPct=e;let t=this.format(),s=this.notice;s&&typeof s.setMessage=="function"?s.setMessage(t):new z.Notice(t,1500)}};var W=require("obsidian"),U=class{constructor(e){this.app=e}async collectNotesFromFolder(e){var r;let t=[],s=(r=e.vaultFolder)==null?void 0:r.trim();if(!s)return{notes:t};let i=this.app.vault.getAbstractFileByPath(s);if(!i)return{notes:t};let o=async l=>{var u;if(l instanceof W.TFolder)for(let c of l.children)await o(c);else if(l instanceof W.TFile){if((l.extension||"").toLowerCase()!=="md")return;let c=await this.app.vault.read(l),g=this.app.metadataCache.getFileCache(l),f=(u=g==null?void 0:g.frontmatter)!=null?u:{};t.push({vaultPath:l.path,relativePath:this.computeRelative(l.path,s),content:c,frontmatter:f})}};return await o(i),{notes:t}}computeRelative(e,t){if(!t)return e;if(e.startsWith(t)){let s=e.slice(t.length);return s=s.replace(/^\/+/,""),s.length>0?s:""}return e}};var Ae=require("obsidian");function $e(n){let e=n.trim();return e.endsWith("/")&&(e=e.slice(0,-1)),e}async function Se(n){if(!n.apiKey)return{status:"missing-api-key"};if(!n.url)return{status:"invalid-url"};let t=`${$e(n.url)}/api/ping`;try{let s=await(0,Ae.requestUrl)({url:t,method:"GET",headers:{"x-api-key":n.apiKey}});if(s.status!==200)return console.warn("[PublishToPersonalVps] Unexpected response status for ping:",s.status),{status:"unexpected-response",message:`HTTP ${s.status}, expected 200`};try{let i=JSON.parse(s.text);return(i==null?void 0:i.status)===200||(i==null?void 0:i.pong)===!0?{status:"success"}:{status:"unexpected-response",message:s.text}}catch(i){return console.warn("[PublishToPersonalVps] Invalid JSON in ping response",i,s.text),{status:"invalid-json",message:i instanceof Error?i.message:String(i)}}}catch(s){return console.error("[PublishToPersonalVps] Connection test failed",s),{status:"failure",message:s instanceof Error?s.message:String(s)}}}var P=require("obsidian");function le(n,e={}){return{...{id:`folder-${Date.now()}`,vaultFolder:"",routeBase:"",vpsId:n,sanitization:{removeFencedCodeBlocks:!0}},...e}}var K=require("obsidian"),O=class extends K.AbstractInputSuggest{constructor(t,s){super(t,s);this.inputEl=s}getSuggestions(t){let s=t.toLowerCase(),i=[];return this.app.vault.getAllLoadedFiles().forEach(o=>{o instanceof K.TFolder&&(!s||o.path.toLowerCase().contains(s))&&i.push(o)}),i}renderSuggestion(t,s){s.setText(t.path)}selectSuggestion(t){this.inputEl.value=t.path,this.inputEl.dispatchEvent(new Event("input")),this.close()}};var M=class extends P.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var L,ue,pe,ce,de,ge,fe,me,he;let{containerEl:e}=this;e.empty();let{t}=B(this.app,this.plugin.settings),s=this.plugin.settings;Array.isArray(s.vpsConfigs)||(s.vpsConfigs=[]),s.vpsConfigs.length===0&&s.vpsConfigs.push({id:"default",name:"VPS",url:"",apiKey:""});let i=s.vpsConfigs[0];Array.isArray(s.folders)||(s.folders=[]),s.ignoreRules||(s.ignoreRules=[]),s.assetsFolder||(s.assetsFolder="assets"),s.enableAssetsVaultFallback==null&&(s.enableAssetsVaultFallback=!0);let o=e.createDiv({cls:"publish-to-personal-vps-settings"});o.createEl("h1",{text:t.settings.tabTitle});let r=o.createDiv({cls:"ptpv-block"});r.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.language.title}),new P.Setting(r).setName(t.settings.language.label).setDesc(t.settings.language.description).addDropdown(p=>{var b;p.addOption("system","System / Syst\xE8me").addOption("en","English").addOption("fr","Fran\xE7ais").setValue((b=s.locale)!=null?b:"system").onChange(async v=>{s.locale=v,await this.plugin.saveSettings(),this.display()})});let u=o.createDiv({cls:"ptpv-block"});u.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.vault.title}),u.createDiv({cls:"ptpv-help",text:(L=t.settings.vault)==null?void 0:L.help}),new P.Setting(u).setName((ue=t.settings.vault)==null?void 0:ue.assetsFolderLabel).setDesc((pe=t.settings.vault)==null?void 0:pe.assetsFolderDescription).addText(p=>p.setPlaceholder("assets").setValue(s.assetsFolder||"assets").onChange(async b=>{s.assetsFolder=b.trim()||"assets",await this.plugin.saveSettings()})),new P.Setting(u).setName((ce=t.settings.vault)==null?void 0:ce.enableAssetsVaultFallbackLabel).setDesc((de=t.settings.vault)==null?void 0:de.enableAssetsVaultFallbackDescription).addToggle(p=>p.setValue(s.enableAssetsVaultFallback).onChange(async b=>{s.enableAssetsVaultFallback=b,await this.plugin.saveSettings()}));let g=o.createDiv({cls:"ptpv-block"});g.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.folders.title}),s.folders.length===0&&s.folders.push(le(i.id)),s.folders.forEach((p,b)=>{var x;let v=g.createEl("fieldset",{cls:"ptpv-folder"});v.createEl("legend",{text:p.vaultFolder&&p.vaultFolder.length>0?p.vaultFolder:`${t.settings.folders.vaultLabel} #${b+1}`}),new P.Setting(v).setName((x=t.settings.folders.deleteButton)!=null?x:"Delete folder").addButton(S=>{S.setIcon("trash").onClick(async()=>{var R;if(this.plugin.settings.folders.length<=1){new P.Notice((R=t.settings.folders.deleteLastForbidden)!=null?R:"At least one folder is required.");return}this.plugin.settings.folders.splice(b,1),await this.plugin.saveSettings(),this.display()})}),new P.Setting(v).setName(t.settings.folders.vaultLabel).setDesc(t.settings.folders.vaultDescription).addText(S=>{S.setPlaceholder("Blog").setValue(p.vaultFolder).onChange(async R=>{p.vaultFolder=R.trim(),await this.plugin.saveSettings()}),new O(this.app,S.inputEl)}),new P.Setting(v).setName(t.settings.folders.routeLabel).setDesc(t.settings.folders.routeDescription).addText(S=>S.setPlaceholder("/blog").setValue(p.routeBase).onChange(async R=>{let T=R.trim();T||(T="/"),T.startsWith("/")||(T="/"+T),p.routeBase=T,await this.plugin.saveSettings()})),new P.Setting(v).setName(t.settings.folders.sanitizeRemoveCodeBlocksLabel).setDesc(t.settings.folders.sanitizeRemoveCodeBlocksDescription).addToggle(S=>{var R,T;return S.setValue((T=(R=p.sanitization)==null?void 0:R.removeFencedCodeBlocks)!=null?T:!0).onChange(async be=>{p.sanitization?p.sanitization.removeFencedCodeBlocks=be:p.sanitization={removeFencedCodeBlocks:be},await this.plugin.saveSettings()})})});let a=o.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(ge=t.settings.folders.addButton)!=null?ge:"Add folder"});a.addClass("mod-cta"),a.onclick=async()=>{var b,v,E;let p=(E=(v=(b=s.vpsConfigs)==null?void 0:b[0])==null?void 0:v.id)!=null?E:"default";this.plugin.settings.folders.push(le(p)),await this.plugin.saveSettings(),this.display()};let m=o.createDiv({cls:"ptpv-block"});m.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.ignoreRules.title}),((fe=s.ignoreRules)!=null?fe:[]).forEach((p,b)=>{var oe;let v=new P.Setting(m).setName(`${(oe=t.settings.ignoreRules.valueLabel)!=null?oe:"Ignore rule"} #${b+1}`);v.addText(V=>{var A;return V.setPlaceholder("frontmatter property").setValue((A=p.property)!=null?A:"").onChange(async x=>{p.property=x.trim(),await this.plugin.saveSettings()})});let E=p.ignoreValues&&p.ignoreValues.length>0?"values":"boolean";v.addDropdown(V=>{var A,x;return V.addOption("boolean",(A=t.settings.ignoreRules.modeBoolean)!=null?A:"Ignore if equals").addOption("values",(x=t.settings.ignoreRules.modeValues)!=null?x:"Ignore specific values").setValue(E).onChange(async S=>{S==="boolean"?(p.ignoreValues=void 0,typeof p.ignoreIf!="boolean"&&(p.ignoreIf=!0)):(p.ignoreIf=void 0,p.ignoreValues||(p.ignoreValues=["draft"])),await this.plugin.saveSettings(),this.display()})}),E==="boolean"?v.addDropdown(V=>V.addOption("true","true").addOption("false","false").setValue(p.ignoreIf===!1?"false":"true").onChange(async A=>{p.ignoreIf=A==="true",await this.plugin.saveSettings()})):v.addText(V=>{var A;return V.setPlaceholder("val1, val2, val3").setValue(((A=p.ignoreValues)!=null?A:[]).join(", ")).onChange(async x=>{p.ignoreValues=x.split(",").map(S=>S.trim()).filter(S=>S.length>0),await this.plugin.saveSettings()})}),v.addExtraButton(V=>{var A;return V.setIcon("trash").setTooltip((A=t.settings.ignoreRules.deleteButton)!=null?A:"Delete ignore rule").onClick(async()=>{var x;(x=s.ignoreRules)==null||x.splice(b,1),await this.plugin.saveSettings(),this.display()})})});let C=o.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(me=t.settings.ignoreRules.addButton)!=null?me:"Add ignore rule"});C.addClass("mod-cta"),C.onclick=async()=>{var b;let p=(b=s.ignoreRules)!=null?b:[];p.push({property:"publish",ignoreIf:!1}),s.ignoreRules=p,await this.plugin.saveSettings(),this.display()};let k=o.createDiv({cls:"ptpv-block"});k.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.vps.title}),new P.Setting(k).setName(t.settings.vps.nameLabel).setDesc(t.settings.vps.nameDescription).addText(p=>p.setPlaceholder("VPS").setValue(i.name).onChange(async b=>{i.name=b.trim(),await this.plugin.saveSettings()})),new P.Setting(k).setName(t.settings.vps.urlLabel).setDesc(t.settings.vps.urlDescription).addText(p=>p.setPlaceholder("https://...").setValue(i.url).onChange(async b=>{i.url=b.trim(),await this.plugin.saveSettings()})),new P.Setting(k).setName(t.settings.vps.apiKeyLabel).setDesc(t.settings.vps.apiKeyDescription).addText(p=>p.setPlaceholder("********").setValue(i.apiKey).onChange(async b=>{i.apiKey=b.trim(),await this.plugin.saveSettings()})),k.createDiv({cls:"ptpv-help",text:t.settings.vps.help});let F=o.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(he=t.settings.testConnection.label)!=null?he:"Test connection"});F.addClass("mod-cta"),F.onclick=async()=>{try{await this.plugin.testConnection()}catch(p){console.error("[PublishToPersonalVps] Connection test failed",p)}}}};var je=/```[\s\S]*?```|~~~[\s\S]*?~~~/g,G=class{execute(e,t){if(!t)return{markdown:e,appliedRules:[]};let s=e,i=[];if(t.removeFencedCodeBlocks){let o=s;s=s.replace(je,""),o!==s&&i.push("removeFencedCodeBlocks")}return{markdown:s,appliedRules:i}}};var J=class{constructor(){this.sanitizeMarkdown=new G}sanitizeNote(e,t){if(!t)return e;let{markdown:s}=this.sanitizeMarkdown.execute(e.content,t);return{...e,content:s}}};function xe(n){return n.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s{2,}/g," ").trim().toLowerCase().replace(/\s/g,"-")}function Ue(n){if(!n)return"";let e=n.trim();return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}function We(n){return n.replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}var q=class{execute(e){let t=Ue(e.folderConfig.routeBase||""),i=We(e.relativePath).split("/").filter(Boolean),o;if(i.length===0){let r="note";o={id:r,slug:r,path:"",routeBase:t,fullPath:t?`${t}/${r}`:`/${r}`}}else{let r=i[i.length-1],l=i.slice(0,-1),u=r.replace(/\.[^/.]+$/,""),c=xe(u),f=l.map(xe).filter(Boolean).join("/"),d=f?`${f}/${c}`:c,a=[t||""];f&&a.push(f),a.push(c);let m=a.filter(Boolean).join("/").replace(/\/{2,}/g,"/");o={id:d,slug:c,path:f,routeBase:t,fullPath:m}}return{...e,routing:o}}};var Oe=/!\[\[([^\]]+)\]\]/g;function Ke(n){let e=n.toLowerCase();return e.match(/\.(png|jpe?g|gif|webp|svg)$/)?"image":e.match(/\.(mp3|wav|flac|ogg)$/)?"audio":e.match(/\.(mp4|webm|mkv|mov)$/)?"video":e.match(/\.pdf$/)?"pdf":"other"}function Me(n){let e=n.toLowerCase();if(e==="left")return"left";if(e==="right")return"right";if(e==="center"||e==="centre")return"center"}function Ge(n){let e,t,s=[],i=[];for(let o of n){let r=o.trim();if(r){if(i.push(r),!e){let l=Me(r);if(l){e=l;continue}}if(!t&&/^[0-9]+$/.test(r)){t=parseInt(r,10);continue}s.push(r)}}return{alignment:e,width:t,classes:s,rawModifiers:i}}var H=class{execute(e){let t=e.content,s=[],i;for(;(i=Oe.exec(t))!==null;){let o=i[0],r=i[1].trim();if(!r)continue;let l=r.split("|").map(d=>d.trim()).filter(Boolean);if(l.length===0)continue;let u=l[0],c=l.slice(1),g=Ke(u),f=Ge(c);g==="other"&&!u.includes(".")||s.push({raw:o,target:u,kind:g,display:f})}return s.length===0?e:{...e,assets:s}}};var Je=/\[\[([^\]]+)\]\]/g;function qe(n){return n.toLowerCase().match(/\.(png|jpe?g|gif|webp|svg|mp3|wav|flac|ogg|mp4|webm|mkv|mov|pdf|md|markdown)$/)?"file":"note"}function Ce(n,e){let t=n.indexOf(e);return t===-1?[n,void 0]:[n.slice(0,t),n.slice(t+e.length)]}var _=class{execute(e){var o;let t=e.content,s=[],i;for(;(i=Je.exec(t))!==null;){let r=i[0],l=i[1].trim();if(!l)continue;let u=(o=i.index)!=null?o:0;if(u>0&&t[u-1]==="!")continue;let[c,g]=Ce(l,"|"),f=c.trim(),d=g&&g.trim().length>0?g.trim():void 0;if(!f)continue;let[a,m]=Ce(f,"#"),w=a.trim(),h=m&&m.trim().length>0?m.trim():void 0;if(!w)continue;let N=qe(w),C={raw:r,target:f,path:w,subpath:h,alias:d,kind:N};s.push(C)}return s.length===0?e:{...e,wikilinks:s}}};function He(n,e){if(!e.includes("."))return n[e];let t=e.split("."),s=n;for(let i of t){if(typeof s!="object"||s===null)return;s=s[i]}return s}function ke(n,e){return n===e}function _e(n,e){if(e.length!==0){if(Array.isArray(n)){for(let t of n)for(let s of e)if(ke(t,s))return s;return}for(let t of e)if(ke(n,t))return t}}var X=class{execute(e){let{frontmatter:t,rules:s}=e;if(!s||s.length===0)return{isPublishable:!0};let i=t.nested;for(let o=0;o<s.length;o++){let r=s[o],l=He(i,r.property);if(l!==void 0){if(r.ignoreIf!==void 0&&typeof l=="boolean"&&l===r.ignoreIf)return{isPublishable:!1,ignoredByRule:{property:r.property,reason:"ignoreIf",matchedValue:r.ignoreIf,ruleIndex:o}};if(r.ignoreValues&&r.ignoreValues.length>0){let u=_e(l,r.ignoreValues);if(u!==void 0)return{isPublishable:!1,ignoredByRule:{property:r.property,reason:"ignoreValues",matchedValue:u,ruleIndex:o}}}}}return{isPublishable:!0}}};function Xe(n,e,t){let s=e.split("."),i=n;for(let o=0;o<s.length;o++){let r=s[o];if(o===s.length-1){i[r]=t;return}(typeof i[r]!="object"||i[r]===null)&&(i[r]={}),i=i[r]}}var Y=class{execute(e){let t=e.raw?{...e.raw}:{},s={};for(let[i,o]of Object.entries(t))i.includes(".")?Xe(s,i,o):s[i]=o;return{flat:t,nested:s}}};var Ye=/`([^`]*?)`/g;function Ze(n,e){let t=e.split(".").filter(Boolean),s=n.nested;for(let i of t){if(s==null||typeof s!="object")return;s=s[i]}return s}function Qe(n){return n==null?"":Array.isArray(n)?n.map(e=>String(e)).join(", "):String(n)}var Z=class{execute(e){let{content:t,frontmatter:s}=e,i=[],o=t.replace(Ye,(r,l)=>{let u=l,c=u.trim();if(!c.startsWith("="))return r;let g=c.slice(1).trim(),f="this.";if(!g.startsWith(f))return r;let d=g.slice(f.length).trim();if(!d)return r;let a=Ze(s,d),m=Qe(a);return i.push({raw:r,code:u,expression:g,propertyPath:d,resolvedValue:a,renderedText:m}),m});return{...e,content:o}}};var Q=class{constructor(e,t,s,i=new J){this.vaultPort=e;this.uploaderPort=t;this.guidGenerator=s;this.contentSanitizer=i;this.normalizeFrontmatter=new Y;this.evaluateIgnoreRules=new X;this.renderInlineDataview=new Z;this.detectAssets=new H;this.detectWikilinks=new _;this.computeRouting=new q}async execute(e,t){var c,g,f,d;if(!((c=e==null?void 0:e.vpsConfigs)!=null&&c.length)||!((g=e==null?void 0:e.folders)!=null&&g.length))return{type:"noConfig"};let s=new Map;for(let a of e.vpsConfigs)a&&a.id&&s.set(a.id,a);let i=[],o=[];for(let a of e.folders){let m=s.get(a.vpsId);if(!m){i.push(a.id);continue}let{notes:w}=await this.vaultPort.collectNotesFromFolder(a);for(let h of w)o.push({vaultPath:h.vaultPath,relativePath:h.relativePath,content:h.content,frontmatter:(f=h.frontmatter)!=null?f:{},folder:a,vpsConfig:m})}if(i.length>0)return{type:"missingVpsConfig",foldersWithoutVps:i};if(o.length===0)return t==null||t.start(0),t==null||t.finish(),{type:"success",publishedCount:0,notes:[]};t==null||t.start(o.length);let r=[];for(let a of o){let m=this.normalizeFrontmatter.execute({raw:a.frontmatter});if(!this.evaluateIgnoreRules.execute({frontmatter:m,rules:(d=e.ignoreRules)!=null?d:null}).isPublishable){t==null||t.advance(1);continue}let h={noteId:this.guidGenerator.generateGuid(),vaultPath:a.vaultPath,relativePath:a.relativePath,content:a.content,frontmatter:m,folderConfig:a.folder,vpsConfig:a.vpsConfig};h=this.renderInlineDataview.execute(h),h=this.contentSanitizer.sanitizeNote(h,a.folder.sanitization),h=this.detectAssets.execute(h),h=this.detectWikilinks.execute(h),h=this.computeRouting.execute(h),r.push(h),t==null||t.advance(1)}if(r.length===0)return t==null||t.finish(),{type:"success",publishedCount:0,notes:[]};let l=new Map;for(let a of r){let m=a.vpsConfig.id,w=l.get(m);w?w.push(a):l.set(m,[a])}let u=0;try{for(let a of l.values())await this.uploaderPort.upload(a),u+=a.length;return t==null||t.finish(),{type:"success",publishedCount:u,notes:r}}catch(a){return t==null||t.finish(),{type:"error",error:a}}}};function et(n){return n.assets!==void 0}function Ve(n){return n.filter(et)}var ee=class{constructor(e,t){this.assetsVaultPort=e;this.assetsUploaderPort=t}async execute(e){var f;let{notes:t,assetsFolder:s,enableAssetsVaultFallback:i,progress:o}=e,r=[],l=[],u=t.filter(d=>Array.isArray(d.assets)&&d.assets.length>0);if(u.length===0)return{type:"noAssets"};let c=0;for(let d of u)for(let a of(f=d.assets)!=null?f:[])try{let m=await this.assetsVaultPort.resolveAssetForNote(d,a,s,i);r.push({noteId:d.noteId,asset:a,resolved:m}),c+=1}catch(m){l.push({noteId:d.noteId,asset:a,reason:"resolve-error",error:m})}if(r.length===0&&l.length>0)return{type:"success",publishedAssetsCount:0,failures:l};o==null||o.start(c);let g=0;try{for(let d of r){if(!d.resolved){l.push({noteId:d.noteId,asset:d.asset,reason:"not-found"}),o==null||o.advance(1);continue}try{await this.assetsUploaderPort.upload([d.resolved]),g+=1}catch(a){l.push({noteId:d.noteId,asset:d.asset,reason:"upload-error",error:a})}o==null||o.advance(1)}return o==null||o.finish(),{type:"success",publishedAssetsCount:g,failures:l}}catch(d){return o==null||o.finish(),{type:"error",error:d}}}};var te=class{constructor(e){this.app=e}async resolveAssetForNote(e,t,s,i){var d;let o=tt(s),r=this.extractLinkTarget(t);if(!r)return console.warn("[ObsidianAssetsVaultAdapter] Unable to extract link target from asset",t),null;let l=this.app.vault.getFiles(),u=(d=r.split("/").pop())!=null?d:r,c;if(o&&(c=l.find(a=>st(a.path,o)?a.path.endsWith("/"+r)||a.path===r?!0:a.name===u:!1)),!c&&i&&(c=l.find(a=>a.path.endsWith("/"+r)||a.path===r?!0:a.name===u)),!c)return console.warn("[ObsidianAssetsVaultAdapter] Asset not found in vault",r,"for note",e.vaultPath),null;let g=nt(c.path,o);return{vaultPath:c.path,fileName:c.name,relativeAssetPath:g}}extractLinkTarget(e){let t=e;if(typeof t.fileName=="string"&&t.fileName.trim())return t.fileName.trim();if(typeof t.target=="string"&&t.target.trim())return t.target.trim();if(typeof t.linkText=="string"&&t.linkText.trim())return t.linkText.trim();if(typeof t.raw=="string"){let s=t.raw,i=s.match(/!\[\[([^\]]+)\]\]/),o=(i?i[1]:s).trim();return o&&o.split("|")[0].trim()||null}return null}};function tt(n){if(!n)return"";let e=n.trim().replace(/\\/g,"/");return e.startsWith("/")&&(e=e.slice(1)),e.endsWith("/")&&(e=e.slice(0,-1)),e}function st(n,e){if(!e)return!1;let t=n.replace(/\\/g,"/");return t===e||t.startsWith(e+"/")}function nt(n,e){let t=n.replace(/\\/g,"/");return e?t===e?"":t.startsWith(e+"/")?t.slice(e.length+1):t:t}var Re=require("obsidian"),se=class{constructor(e){this.vpsConfig=e}async upload(e){var u;if(!Array.isArray(e)||e.length===0)return;let t=(u=e[0].vpsConfig)!=null?u:this.vpsConfig,s=t.apiKey,o={assets:await Promise.all(e.map(async c=>await this.buildApiAsset(c)))},r=await(0,Re.requestUrl)({url:t.url.replace(/\/$/,"")+"/api/upload-assets",method:"POST",headers:{"Content-Type":"application/json","x-api-key":s},body:JSON.stringify(o)});if(r.status<200||r.status>=300)throw new Error(`Asset upload failed with status ${r.status}: ${r.text}`);let l=r.json;if(!l||l.ok!==!0)throw new Error(`Upload API returned an error: ${JSON.stringify(l)}`)}async buildApiAsset(e){var t;return{relativePath:e.relativeAssetPath,vaultPath:e.vaultPath,fileName:e.fileName,mimeType:(t=e.mimeType)!=null?t:this.guessMimeType(e.fileName),contentBase64:await this.toBase64(e.content)}}async toBase64(e){if(e instanceof ArrayBuffer)return Buffer.from(e).toString("base64");if(e instanceof Uint8Array)return Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64");throw new Error("Unsupported asset content type")}guessMimeType(e){var s;switch((s=e.split(".").pop())==null?void 0:s.toLowerCase()){case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"gif":return"image/gif";case"svg":return"image/svg+xml";case"webp":return"image/webp";case"pdf":return"application/pdf";default:return"application/octet-stream"}}};var Te=require("obsidian"),ne=class{constructor(e){this.vpsConfig=e}async upload(e){var u;if(!Array.isArray(e)||e.length===0)return;let t=(u=e[0].vpsConfig)!=null?u:this.vpsConfig,s=t.apiKey,o={notes:e.map(c=>this.buildApiNote(c))},r=await(0,Te.requestUrl)({url:t.url.replace(/\/$/,"")+"/api/upload",method:"POST",headers:{"Content-Type":"application/json","x-api-key":s},body:JSON.stringify(o)});if(r.status<200||r.status>=300)throw new Error(`Upload failed with status ${r.status}: ${r.text}`);let l=r.json;if(!l||l.api!=="ok")throw new Error(`Upload API returned an error: ${JSON.stringify(l)}`)}buildApiNote(e){var g,f,d,a,m,w,h,N,C,k,D,I,F;let t=(g=e.frontmatter)!=null?g:{},s=(d=(f=t.slug)!=null?f:t.title)!=null?d:this.extractFileNameWithoutExt(e.vaultPath),i=this.slugify(s),o=((m=(a=e.folderConfig)==null?void 0:a.routeBase)!=null?m:"").replace(/\/+$/,""),r=`${o||""}/${e.relativePath}/${i}`.replace(/\/{2,}/g,"/");r.startsWith("/")||(r=`/${r}`);let l=new Date().toISOString(),u=(h=(w=this.toIsoString(t.publishedAt))!=null?w:this.toIsoString(t.date))!=null?h:l,c=(N=this.toIsoString(t.updatedAt))!=null?N:u;return{id:(k=(C=e.relativePath)!=null?C:e.vaultPath)!=null?k:r,slug:i,route:r,relativePath:e.relativePath,vaultPath:e.vaultPath,markdown:e.content,frontmatter:{title:(D=t.title)!=null?D:s,description:(I=t.description)!=null?I:"",date:(F=this.toIsoString(t.date))!=null?F:u,tags:this.toStringArray(t.tags)},publishedAt:u,updatedAt:c}}extractFileNameWithoutExt(e){var s;return((s=e.split("/").pop())!=null?s:e).replace(/\.[^/.]+$/,"")}slugify(e){return e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").trim()}toIsoString(e){if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e.toISOString();if(typeof e=="string"){let t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()}if(typeof e.toISOString=="function")try{let t=e.toISOString(),s=new Date(t);return isNaN(s.getTime())?null:s.toISOString()}catch(t){return null}return null}toStringArray(e){return e?Array.isArray(e)?e.map(t=>typeof t=="string"?t:String(t)).map(t=>t.trim()).filter(Boolean):typeof e=="string"?e.split(",").map(t=>t.trim()).filter(Boolean):[]:[]}};var it={vpsConfigs:[],folders:[],ignoreRules:[],locale:"system",assetsFolder:"assets",enableAssetsVaultFallback:!0};function Fe(n){return JSON.parse(JSON.stringify(n))}function ot(n){let e=Fe(n);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:Pe(t.apiKey)}))),e}function rt(n){let e=Fe(n);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:we(t.apiKey)}))),e}function at(n){let{vpsConfigs:e,folders:t,ignoreRules:s}=n;return{vpsConfigs:e,folders:t,ignoreRules:s}}var ie=class extends y.Plugin{async onload(){await this.loadSettings();let{t:e}=B(this.app,this.settings);this.addSettingTab(new M(this.app,this)),this.addCommand({id:"publish-to-personal-vps",name:e.plugin.commandPublish,callback:()=>this.publishToSite()}),this.addCommand({id:"test-vps-connection",name:e.plugin.commandTestConnection,callback:()=>this.testConnection()}),this.addCommand({id:"open-vps-settings",name:e.plugin.commandOpenSettings,callback:()=>{this.app.setting.open(),this.app.setting.openTabById(`${this.manifest.id}`)}}),this.addRibbonIcon("rocket",e.plugin.commandPublish,async()=>{try{await this.publishToSite()}catch(t){console.error("[PublishToPersonalVps] Publish failed from ribbon",t),new y.Notice(e.plugin.publishError)}})}async loadSettings(){var i;let e=(i=await this.loadData())!=null?i:{},t=null;try{let o=this.app.vault.adapter,l=`${`.obsidian/plugins/${this.manifest.id}`}/settings.json`;if(await o.exists(l)){let u=await o.read(l);t=JSON.parse(u)}}catch(o){console.warn("[PublishToPersonalVps] Failed to read settings.json snapshot",o)}let s={...it,...e,...t};this.settings=rt(s)}async saveSettings(){let e=ot(this.settings);await this.saveData(e)}async publishToSite(){var k,D,I;let e=this.settings,{t}=B(this.app,this.settings);if(!e.vpsConfigs||e.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new y.Notice((D=(k=t.settings.errors)==null?void 0:k.missingVpsConfig)!=null?D:"No VPS configured");return}if(!e.folders||e.folders.length===0){console.warn("[PublishToPersonalVps] No folders configured"),new y.Notice("\u26A0\uFE0F No folders configured for publishing.");return}let s=new U(this.app),i=new j,o=e.vpsConfigs[0],r=new ne(o),l=new Q(s,r,i),u=new $,c=at(e),g=await l.execute(c,u);if(g.type==="noConfig"){new y.Notice("\u26A0\uFE0F No folders or VPS configured.");return}if(g.type==="missingVpsConfig"){console.warn("[PublishToPersonalVps] Missing VPS for folders:",g.foldersWithoutVps),new y.Notice("\u26A0\uFE0F Some folder(s) have no VPS configured (see console).");return}if(g.type==="error"){console.error(g.error),new y.Notice("\u274C Error during publishing (see console).");return}let f=g.publishedCount,d=(I=g.notes)!=null?I:[];if(f===0){new y.Notice("\u2705 Nothing to publish (0 note).");return}let a=Ve(d);if(a.length===0){new y.Notice(`\u2705 Published ${f} note(s). No assets to publish.`);return}let m=new te(this.app),w=new se(o),h=new ee(m,w),N=new $,C=await h.execute({notes:a,assetsFolder:e.assetsFolder,enableAssetsVaultFallback:e.enableAssetsVaultFallback,progress:N});switch(C.type){case"noAssets":{new y.Notice(`\u2705 Published ${f} note(s). No assets to publish.`);break}case"error":{console.error("[PublishToPersonalVps] Error while publishing assets:",C.error),new y.Notice(`\u2705 Published ${f} note(s), but assets publication failed (see console).`);break}case"success":{let{publishedAssetsCount:F,failures:L}=C;L.length>0?(console.warn("[PublishToPersonalVps] Some assets failed to publish:",L),new y.Notice(`\u2705 Published ${f} note(s) and ${F} asset(s), with ${L.length} asset failure(s) (see console).`)):new y.Notice(`\u2705 Published ${f} note(s) and ${F} asset(s).`);break}}}async testConnection(){let{t:e}=B(this.app,this.settings),t=this.settings;if(!(t!=null&&t.vpsConfigs)||t.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new y.Notice(e.settings.errors.missingVpsConfig);return}let s=t.vpsConfigs[0],i=await Se(s);switch(i.message&&console.log("[PublishToPersonalVps] Test connection message:",i.message),i.status){case"success":new y.Notice(e.settings.testConnection.success);break;case"failure":new y.Notice(e.settings.testConnection.failed);break;case"unexpected-response":new y.Notice(e.settings.testConnection.unexpectedResponsePrefix+i);break;case"invalid-json":new y.Notice(e.settings.testConnection.invalidJson);break;case"missing-api-key":new y.Notice(e.settings.testConnection.missingApiKey);break;case"invalid-url":new y.Notice(e.settings.testConnection.invalidUrl);break;default:new y.Notice(e.settings.testConnection.resultPrefix+i);break}}};
