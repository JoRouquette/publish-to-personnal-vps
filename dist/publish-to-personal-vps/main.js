/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var bt=Object.create;var E=Object.defineProperty;var vt=Object.getOwnPropertyDescriptor;var yt=Object.getOwnPropertyNames;var Pt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var St=(i,t)=>{for(var e in t)E(i,e,{get:t[e],enumerable:!0})},ot=(i,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of yt(t))!wt.call(i,s)&&s!==e&&E(i,s,{get:()=>t[s],enumerable:!(n=vt(t,s))||n.enumerable});return i};var Ct=(i,t,e)=>(e=i!=null?bt(Pt(i)):{},ot(t||!i||!i.__esModule?E(e,"default",{value:i,enumerable:!0}):e,i)),kt=i=>ot(E({},"__esModule",{value:!0}),i);var Ot={};St(Ot,{default:()=>_});module.exports=kt(Ot);var ft=Ct(require("fs"),1),f=require("obsidian"),mt=require("util");var rt={plugin:{name:"Publish To Personal VPS",commandPublish:"Launch publishing to Personal VPS",commandTestConnection:"Test VPS connection",commandOpenSettings:"Open Publish To Personal VPS Settings",publishSuccess:"Publishing completed.",publishError:"Error during publishing (see console).",noConfig:"No VPS or folder configuration defined.",error:{failureToExportSettings:"Failed to export settings."}},settings:{tabTitle:"Publish To Personal VPS",errors:{missingVpsConfig:"VPS configuration not found for folder: "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"draft",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"Language selection",label:"Language",description:"Choose plugin language."},vps:{title:"VPS configuration",nameLabel:"Name",nameDescription:"Internal name for this VPS.",urlLabel:"URL",urlDescription:"Example: https://notes.mydomain.com",apiKeyLabel:"API key",apiKeyDescription:"Key used to authenticate uploads.",help:"HTTP requests to /api/upload will use this URL and API key."},folders:{title:"Folders to publish",addButton:"Add folder",deleteButton:"Delete folder",deleteLastForbidden:"At least one folder is required.",vaultLabel:"Vault folder",vaultDescription:"Example: Blog, Notes/Docs, etc.",routeLabel:"Site route",routeDescription:"Example: /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Remove fenced code blocks",sanitizeRemoveCodeBlocksDescription:"If enabled, fenced code blocks (``` or ~~~) will be removed from the content before publishing.",rulesHelp:"Notes whose frontmatter matches the ignore rules below will not be published."},ignoreRules:{title:"Ignore rules",description:"Notes with these frontmatter properties will be ignored during publishing.",help:"You can define global rules based on frontmatter properties and values.",addButton:"Add ignore rule",deleteButton:"Delete ignore rule",propertyLabel:"Frontmatter property",propertyDescription:"Property to inspect in the frontmatter.",valueLabel:"Value(s) to ignore",valueDescription:"Comma-separated list of values to ignore for this property.",modeValues:"Ignore specific values",modeBoolean:"Ignore if equal (true/false)"},testConnection:{label:"Test connection",notImplemented:"Connection test not implemented yet.",failed:"Connection test failed.",success:"Connection test succeeded.",invalidConfig:"Invalid VPS configuration.",invalidJson:"Invalid JSON response.",missingApiKey:"Missing API key.",invalidUrl:"Invalid URL.",resultPrefix:"Test connection result: ",unexpectedResponsePrefix:"Unexpected response from server: "}}},at={plugin:{name:"Publier vers mon VPS personnel",commandPublish:"Publier vers mon VPS personnel",commandTestConnection:"Tester la connexion VPS",commandOpenSettings:"Ouvrir les param\xE8tres du plugin Publier vers mon VPS personnel",publishSuccess:"Publication termin\xE9e.",publishError:"Erreur lors de la publication (voir la console).",noConfig:"Aucune configuration VPS ou dossier d\xE9finie.",error:{failureToExportSettings:"\xC9chec de l\u2019exportation des param\xE8tres."}},settings:{tabTitle:"Publier vers mon VPS personnel",errors:{missingVpsConfig:"Configuration VPS introuvable pour le dossier : "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"brouillon",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"S\xE9lection de la langue",label:"Langue",description:"Choisir la langue du plugin."},vps:{title:"Configuration du VPS",nameLabel:"Nom",nameDescription:"Nom interne pour ce VPS.",urlLabel:"URL",urlDescription:"Ex : https://notes.mondomaine.fr",apiKeyLabel:"Cl\xE9 API",apiKeyDescription:"Cl\xE9 utilis\xE9e pour authentifier les envois.",help:"Les requ\xEAtes HTTP vers /api/upload utiliseront cette URL et cette cl\xE9."},folders:{title:"Dossiers \xE0 publier",addButton:"Ajouter un dossier",deleteButton:"Supprimer le dossier",deleteLastForbidden:"Au moins un dossier est requis.",vaultLabel:"Dossier du vault",vaultDescription:"Ex : Blog, Notes/Docs, etc.",routeLabel:"Route du site",routeDescription:"Ex : /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Supprimer les blocs de code d\xE9limit\xE9s",sanitizeRemoveCodeBlocksDescription:"Si activ\xE9, les blocs de code d\xE9limit\xE9s (``` ou ~~~) seront supprim\xE9s du contenu avant publication.",rulesHelp:"Les notes dont le frontmatter correspond aux r\xE8gles ci-dessous ne seront pas publi\xE9es."},ignoreRules:{title:"R\xE8gles d\u2019ignorance",description:"Les notes avec ces propri\xE9t\xE9s de frontmatter seront ignor\xE9es lors de la publication.",help:"Vous pouvez d\xE9finir des r\xE8gles globales bas\xE9es sur les propri\xE9t\xE9s et valeurs du frontmatter.",addButton:"Ajouter une r\xE8gle d'ignorance",deleteButton:"Supprimer la r\xE8gle d'ignorance",propertyLabel:"Propri\xE9t\xE9 du frontmatter",propertyDescription:"Propri\xE9t\xE9 \xE0 inspecter dans le frontmatter.",valueLabel:"Valeur(s) \xE0 ignorer",valueDescription:"Liste de valeurs \xE0 ignorer pour cette propri\xE9t\xE9 (s\xE9par\xE9es par des virgules).",modeValues:"Ignorer des valeurs sp\xE9cifiques",modeBoolean:"Ignorer si \xE9gal (true/false)"},testConnection:{label:"Tester la connexion",notImplemented:"Test de connexion non impl\xE9ment\xE9 pour l\u2019instant.",failed:"\xC9chec du test de connexion.",success:"Test de connexion r\xE9ussi.",invalidConfig:"Configuration VPS invalide.",invalidJson:"R\xE9ponse JSON invalide.",missingApiKey:"Cl\xE9 API manquante.",invalidUrl:"URL invalide.",resultPrefix:"R\xE9sultat du test de connexion : ",unexpectedResponsePrefix:"R\xE9ponse inattendue du serveur : "}}};function xt(i){let t=navigator.language||navigator.userLanguage||"en";return String(t).toLowerCase().startsWith("fr")?"fr":"en"}function N(i,t){let e;return!t||t.locale==="system"||!t.locale?e=xt(i):e=t.locale,{locale:e,t:e==="fr"?at:rt}}var Z="enc:";function lt(i){if(!i)return"";try{return Z+btoa(i)}catch(t){return i}}function ut(i){if(!i)return"";if(!i.startsWith(Z))return i;let t=i.slice(Z.length);try{return atob(t)}catch(e){return""}}var ct=require("obsidian"),z=class{constructor(t){this.vpsConfig=t}async uploadNotes(t){var c;if(!Array.isArray(t)||t.length===0)return;let e=(c=t[0].vpsConfig)!=null?c:this.vpsConfig,n=e.apiKey,r={notes:t.map(p=>this.buildApiNote(p))},o=await(0,ct.requestUrl)({url:e.url.replace(/\/$/,"")+"/api/upload",method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify(r)});if(o.status<200||o.status>=300)throw new Error(`Upload failed with status ${o.status}: ${o.text}`);let a=o.json;if(!a||a.ok!==!0)throw new Error(`Upload API returned an error: ${JSON.stringify(a)}`)}buildApiNote(t){var d,m,x,D,S,u,h,k,v,R,I,T,L;let e=(d=t.frontmatter)!=null?d:{},n=(x=(m=e.slug)!=null?m:e.title)!=null?x:this.extractFileNameWithoutExt(t.vaultPath),s=this.slugify(n),r=((S=(D=t.folderConfig)==null?void 0:D.routeBase)!=null?S:"").replace(/\/+$/,""),o=`${r||""}/${t.relativePath}/${s}`.replace(/\/{2,}/g,"/");o.startsWith("/")||(o=`/${o}`);let a=new Date().toISOString(),c=(h=(u=this.toIsoString(e.publishedAt))!=null?u:this.toIsoString(e.date))!=null?h:a,p=(k=this.toIsoString(e.updatedAt))!=null?k:c;return{id:(R=(v=t.relativePath)!=null?v:t.vaultPath)!=null?R:o,slug:s,route:o,relativePath:t.relativePath,vaultPath:t.vaultPath,markdown:t.content,frontmatter:{title:(I=e.title)!=null?I:n,description:(T=e.description)!=null?T:"",date:(L=this.toIsoString(e.date))!=null?L:c,tags:this.toStringArray(e.tags)},publishedAt:c,updatedAt:p}}extractFileNameWithoutExt(t){var n;return((n=t.split("/").pop())!=null?n:t).replace(/\.[^/.]+$/,"")}slugify(t){return t.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").trim()}toIsoString(t){if(!t)return null;if(t instanceof Date)return isNaN(t.getTime())?null:t.toISOString();if(typeof t=="string"){let e=new Date(t);return isNaN(e.getTime())?null:e.toISOString()}if(typeof t.toISOString=="function")try{let e=t.toISOString(),n=new Date(e);return isNaN(n.getTime())?null:n.toISOString()}catch(e){return null}return null}toStringArray(t){return t?Array.isArray(t)?t.map(e=>typeof e=="string"?e:String(e)).map(e=>e.trim()).filter(Boolean):typeof t=="string"?t.split(",").map(e=>e.trim()).filter(Boolean):[]:[]}};var O=require("obsidian"),K=class{constructor(t){this.app=t}async collectNotesFromFolder(t){var o;let e=[],n=(o=t.vaultFolder)==null?void 0:o.trim();if(!n)return{notes:e};let s=this.app.vault.getAbstractFileByPath(n);if(!s)return{notes:e};let r=async a=>{var c;if(a instanceof O.TFolder)for(let p of a.children)await r(p);else if(a instanceof O.TFile){if((a.extension||"").toLowerCase()!=="md")return;let p=await this.app.vault.read(a),d=this.app.metadataCache.getFileCache(a),m=(c=d==null?void 0:d.frontmatter)!=null?c:{};e.push({vaultPath:a.path,relativePath:this.computeRelative(a.path,n),content:p,frontmatter:m})}};return await r(s),{notes:e}}computeRelative(t,e){if(!e)return t;if(t.startsWith(e)){let n=t.slice(e.length);return n=n.replace(/^\/+/,""),n.length>0?n:""}return t}};var w=require("obsidian");function Q(i,t={}){return{...{id:`folder-${Date.now()}`,vaultFolder:"",routeBase:"",vpsId:i,sanitization:{removeFencedCodeBlocks:!0}},...t}}var W=require("obsidian"),$=class extends W.AbstractInputSuggest{constructor(e,n){super(e,n);this.inputEl=n}getSuggestions(e){let n=e.toLowerCase(),s=[];return this.app.vault.getAllLoadedFiles().forEach(r=>{r instanceof W.TFolder&&(!n||r.path.toLowerCase().contains(n))&&s.push(r)}),s}renderSuggestion(e,n){n.setText(e.path)}selectSuggestion(e){this.inputEl.value=e.path,this.inputEl.dispatchEvent(new Event("input")),this.close()}};var U=class extends w.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){var T,L,tt,et,nt;let{containerEl:t}=this;t.empty();let{t:e}=N(this.app,this.plugin.settings),n=this.plugin.settings,s=t.createDiv({cls:"publish-to-personal-vps-settings"});s.createEl("h1",{text:e.settings.tabTitle});let o=s.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});o.createEl("h6",{text:e.settings.language.title}),new w.Setting(o).setName(e.settings.language.label).setDesc(e.settings.language.description).addDropdown(l=>{var g;l.addOption("system","System / Syst\xE8me").addOption("en","English").addOption("fr","Fran\xE7ais").setValue((g=n.locale)!=null?g:"system").onChange(async b=>{n.locale=b,await this.plugin.saveSettings(),this.display()})});let a=(T=n.vpsConfigs)==null?void 0:T[0];a||(a={id:"default",name:"VPS",url:"",apiKey:""},n.vpsConfigs=[a]);let c=s.createDiv({cls:"ptpv-block"}),p=c.createDiv({cls:"ptpv-block-title"});p.createEl("h6",{text:e.settings.vps.title}),new w.Setting(p).setName(e.settings.vps.nameLabel).setDesc(e.settings.vps.nameDescription).addText(l=>l.setPlaceholder("VPS").setValue(a.name).onChange(async g=>{a.name=g.trim(),await this.plugin.saveSettings()})),new w.Setting(c).setName(e.settings.vps.urlLabel).setDesc(e.settings.vps.urlDescription).addText(l=>l.setPlaceholder("https://...").setValue(a.url).onChange(async g=>{a.url=g.trim(),await this.plugin.saveSettings()})),new w.Setting(c).setName(e.settings.vps.apiKeyLabel).setDesc(e.settings.vps.apiKeyDescription).addText(l=>l.setPlaceholder("********").setValue(a.apiKey).onChange(async g=>{a.apiKey=g.trim(),await this.plugin.saveSettings()})),c.createDiv({cls:"ptpv-help",text:e.settings.vps.help});let d=s.createDiv({cls:"ptpv-block"});d.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:e.settings.ignoreRules.title}),((L=n.ignoreRules)!=null?L:[]).forEach((l,g)=>{var Y;let b=new w.Setting(d).setName(`${(Y=e.settings.ignoreRules.valueLabel)!=null?Y:"Ignore rule"} #${g+1}`);b.addText(V=>{var y;return V.setPlaceholder("frontmatter property").setValue((y=l.property)!=null?y:"").onChange(async C=>{l.property=C.trim(),await this.plugin.saveSettings()})});let F=l.ignoreValues&&l.ignoreValues.length>0?"values":"boolean";b.addDropdown(V=>{var y,C;return V.addOption("boolean",(y=e.settings.ignoreRules.modeBoolean)!=null?y:"Ignore if equals").addOption("values",(C=e.settings.ignoreRules.modeValues)!=null?C:"Ignore specific values").setValue(F).onChange(async P=>{P==="boolean"?(l.ignoreValues=void 0,typeof l.ignoreIf!="boolean"&&(l.ignoreIf=!0)):(l.ignoreIf=void 0,l.ignoreValues||(l.ignoreValues=["draft"])),await this.plugin.saveSettings(),this.display()})}),F==="boolean"?b.addDropdown(V=>V.addOption("true","true").addOption("false","false").setValue(l.ignoreIf===!1?"false":"true").onChange(async y=>{l.ignoreIf=y==="true",await this.plugin.saveSettings()})):b.addText(V=>{var y;return V.setPlaceholder("val1, val2, val3").setValue(((y=l.ignoreValues)!=null?y:[]).join(", ")).onChange(async C=>{l.ignoreValues=C.split(",").map(P=>P.trim()).filter(P=>P.length>0),await this.plugin.saveSettings()})}),b.addExtraButton(V=>{var y;return V.setIcon("trash").setTooltip((y=e.settings.ignoreRules.deleteButton)!=null?y:"Delete ignore rule").onClick(async()=>{var C;(C=n.ignoreRules)==null||C.splice(g,1),await this.plugin.saveSettings(),this.display()})})});let S=s.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(tt=e.settings.ignoreRules.addButton)!=null?tt:"Add ignore rule"});S.addClass("mod-cta"),S.onclick=async()=>{var g;let l=(g=n.ignoreRules)!=null?g:[];l.push({property:"publish",ignoreIf:!1}),n.ignoreRules=l,await this.plugin.saveSettings(),this.display()};let h=s.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});h.createEl("h6",{text:e.settings.folders.title}),Array.isArray(n.folders)||(n.folders=[]),n.folders.length===0&&n.folders.push(Q(a.id)),n.folders.forEach((l,g)=>{var C;let b=h.createEl("fieldset",{cls:"ptpv-folder"});b.createEl("legend",{text:l.vaultFolder&&l.vaultFolder.length>0?l.vaultFolder:`${e.settings.folders.vaultLabel} #${g+1}`}),new w.Setting(b).setName((C=e.settings.folders.deleteButton)!=null?C:"Delete folder").addButton(P=>{P.setIcon("trash").onClick(async()=>{var A;if(this.plugin.settings.folders.length<=1){new w.Notice((A=e.settings.folders.deleteLastForbidden)!=null?A:"At least one folder is required.");return}this.plugin.settings.folders.splice(g,1),await this.plugin.saveSettings(),this.display()})}),new w.Setting(b).setName(e.settings.folders.vaultLabel).setDesc(e.settings.folders.vaultDescription).addText(P=>{P.setPlaceholder("Blog").setValue(l.vaultFolder).onChange(async A=>{l.vaultFolder=A.trim(),await this.plugin.saveSettings()}),new $(this.app,P.inputEl)}),new w.Setting(b).setName(e.settings.folders.routeLabel).setDesc(e.settings.folders.routeDescription).addText(P=>P.setPlaceholder("/blog").setValue(l.routeBase).onChange(async A=>{l.routeBase=A.trim(),await this.plugin.saveSettings()})),new w.Setting(b).setName(e.settings.folders.sanitizeRemoveCodeBlocksLabel).setDesc(e.settings.folders.sanitizeRemoveCodeBlocksDescription).addToggle(P=>{var A,it;return P.setValue((it=(A=l.sanitization)==null?void 0:A.removeFencedCodeBlocks)!=null?it:!0).onChange(async st=>{l.sanitization?l.sanitization.removeFencedCodeBlocks=st:l.sanitization={removeFencedCodeBlocks:st},await this.plugin.saveSettings()})})});let v=s.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(et=e.settings.folders.addButton)!=null?et:"Add folder"});v.addClass("mod-cta"),v.onclick=async()=>{var g,b,F;let l=(F=(b=(g=n.vpsConfigs)==null?void 0:g[0])==null?void 0:b.id)!=null?F:"default";this.plugin.settings.folders.push(Q(l)),await this.plugin.saveSettings(),this.display()};let I=s.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(nt=e.settings.testConnection.label)!=null?nt:"Test connection"});I.addClass("mod-cta"),I.onclick=async()=>{try{await this.plugin.testConnection()}catch(l){console.error("[PublishToPersonalVps] Connection test failed",l)}}}};async function pt(i){var r;let t=((r=i.url)!=null?r:"").trim();if(!t)return"invalid-url";if(!i.apiKey)return"missing-api-key";let e=`${t.replace(/\/$/,"")}/api/ping`,n=await fetch(e,{method:"GET",headers:{"x-api-key":i.apiKey}});if(!n.ok)return`HTTP ${n.status}`;let s=null;try{s=await n.json()}catch(o){return"invalid-json"}return!s||s.ok!==!0?"unexpected-response":"success"}var B=require("obsidian"),j=class{constructor(){this.notice=null;this.total=0;this.current=0;this.lastPct=-1}start(t){this.total=Math.max(1,t),this.current=0,this.notice=new B.Notice(this.format(),0),this.update()}advance(t=1){this.current=Math.min(this.total,this.current+t),this.update()}finish(){var t,e;try{(e=(t=this.notice)==null?void 0:t.hide)==null||e.call(t)}catch(n){}this.notice=null,this.total>0&&this.current===this.total?new B.Notice("\u2705 Upload completed"):new B.Notice("\u26A0\uFE0F Upload ended prematurely")}format(){let t=Math.floor(this.current/this.total*100);return`Uploading notes\u2026 ${this.current}/${this.total} (${t}%)`}update(){let t=Math.floor(this.current/this.total*100);if(t===this.lastPct&&this.current!==this.total)return;this.lastPct=t;let e=this.format(),n=this.notice;n&&typeof n.setMessage=="function"?n.setMessage(e):new B.Notice(e,1500)}};var M=class{sanitize(t,e){if(!e)return t;let n=t;if(e.removeFencedCodeBlocks){let s=/^```[^\n]*\n[\s\S]*?^```[ \t]*\n?/gm,r=/^~~~[^\n]*\n[\s\S]*?^~~~[ \t]*\n?/gm;n=n.replace(s,""),n=n.replace(r,"")}return n}sanitizeNote(t,e){let n=this.sanitize(t.content,e);return{...t,content:n}}};var Vt=/!\[\[([^\]]+)\]\]/g;function At(i){let t=i.toLowerCase();return t.match(/\.(png|jpe?g|gif|webp|svg)$/)?"image":t.match(/\.(mp3|wav|flac|ogg)$/)?"audio":t.match(/\.(mp4|webm|mkv|mov)$/)?"video":t.match(/\.pdf$/)?"pdf":"other"}function Dt(i){let t=i.toLowerCase();if(t==="left")return"left";if(t==="right")return"right";if(t==="center"||t==="centre")return"center"}function Rt(i){let t,e,n=[],s=[];for(let r of i){let o=r.trim();if(o){if(s.push(o),!t){let a=Dt(o);if(a){t=a;continue}}if(!e&&/^[0-9]+$/.test(o)){e=parseInt(o,10);continue}n.push(o)}}return{alignment:t,width:e,classes:n,rawModifiers:s}}var H=class{execute(t){let{markdown:e}=t,n=[],s;for(;(s=Vt.exec(e))!==null;){let r=s[0],o=s[1].trim();if(!o)continue;let a=o.split("|").map(x=>x.trim()).filter(Boolean);if(a.length===0)continue;let c=a[0],p=a.slice(1),d=At(c),m=Rt(p);d==="other"&&!c.includes(".")||n.push({raw:r,target:c,kind:d,display:m})}return{assets:n}}};var It=/\[\[([^\]]+)\]\]/g;function Tt(i){return i.toLowerCase().match(/\.(png|jpe?g|gif|webp|svg|mp3|wav|flac|ogg|mp4|webm|mkv|mov|pdf|md|markdown)$/)?"file":"note"}function dt(i,t){let e=i.indexOf(t);return e===-1?[i,void 0]:[i.slice(0,e),i.slice(e+t.length)]}var q=class{execute(t){var r;let{markdown:e}=t,n=[],s;for(;(s=It.exec(e))!==null;){let o=s[0],a=s[1].trim();if(!a)continue;let c=(r=s.index)!=null?r:0;if(c>0&&e[c-1]==="!")continue;let[p,d]=dt(a,"|"),m=p.trim(),x=d&&d.trim().length>0?d.trim():void 0;if(!m)continue;let[D,S]=dt(m,"#"),u=D.trim(),h=S&&S.trim().length>0?S.trim():void 0;if(!u)continue;let k=Tt(u),v={raw:o,target:m,path:u,subpath:h,alias:x,kind:k};n.push(v)}return{wikilinks:n}}};function Ft(i,t){if(!t.includes("."))return i[t];let e=t.split("."),n=i;for(let s of e){if(typeof n!="object"||n===null)return;n=n[s]}return n}function gt(i,t){return i===t}function Nt(i,t){if(t.length!==0){if(Array.isArray(i)){for(let e of i)for(let n of t)if(gt(e,n))return n;return}for(let e of t)if(gt(i,e))return e}}var J=class{execute(t){let{frontmatter:e,rules:n}=t;if(!n||n.length===0)return{isPublishable:!0};let s=e.nested;for(let r=0;r<n.length;r++){let o=n[r],a=Ft(s,o.property);if(a!==void 0){if(o.ignoreIf!==void 0&&typeof a=="boolean"&&a===o.ignoreIf)return{isPublishable:!1,ignoredByRule:{property:o.property,reason:"ignoreIf",matchedValue:o.ignoreIf,ruleIndex:r}};if(o.ignoreValues&&o.ignoreValues.length>0){let c=Nt(a,o.ignoreValues);if(c!==void 0)return{isPublishable:!1,ignoredByRule:{property:o.property,reason:"ignoreValues",matchedValue:c,ruleIndex:r}}}}}return{isPublishable:!0}}};function Lt(i,t,e){let n=t.split("."),s=i;for(let r=0;r<n.length;r++){let o=n[r];if(r===n.length-1){s[o]=e;return}(typeof s[o]!="object"||s[o]===null)&&(s[o]={}),s=s[o]}}var G=class{execute(t){let e=t.raw?{...t.raw}:{},n={};for(let[s,r]of Object.entries(e))s.includes(".")?Lt(n,s,r):n[s]=r;return{flat:e,nested:n}}};var X=class{constructor(t,e,n=new M){this.vaultPort=t;this.uploaderPort=e;this.contentSanitizer=n;this.normalizeFrontmatter=new G;this.evaluateIgnoreRules=new J;this.detectAssets=new H;this.detectWikilinks=new q}async execute(t,e){var m,x,D,S;if(!((m=t==null?void 0:t.vpsConfigs)!=null&&m.length)||!((x=t==null?void 0:t.folders)!=null&&x.length))return{type:"noConfig"};let n=new Map;for(let u of t.vpsConfigs)u&&u.id&&n.set(u.id,u);let s=[],r=[];for(let u of t.folders){let h=n.get(u.vpsId);if(!h){s.push(u.id);continue}let{notes:k}=await this.vaultPort.collectNotesFromFolder(u);for(let v of k)r.push({vaultPath:v.vaultPath,relativePath:v.relativePath,content:v.content,frontmatter:(D=v.frontmatter)!=null?D:{},folder:u,vpsConfig:h})}if(s.length>0)return{type:"missingVpsConfig",foldersWithoutVps:s};if(r.length===0)return e==null||e.start(0),e==null||e.finish(),{type:"success",publishedCount:0};e==null||e.start(r.length);let o=[],a=[],c=[];for(let u of r){let h=this.normalizeFrontmatter.execute({raw:u.frontmatter});if(!this.evaluateIgnoreRules.execute({frontmatter:h,rules:(S=t.ignoreRules)!=null?S:null}).isPublishable){e==null||e.advance(1);continue}let v={vaultPath:u.vaultPath,relativePath:this.slugify(u.relativePath),content:u.content,frontmatter:h,folderConfig:u.folder,vpsConfig:u.vpsConfig},R=this.contentSanitizer.sanitizeNote(v,u.folder.sanitization),{assets:I}=this.detectAssets.execute({markdown:R.content});I.length>0&&a.push(...I);let{wikilinks:T}=this.detectWikilinks.execute({markdown:R.content});T.length>0&&c.push({noteId:R.vaultPath,wikilinks:T}),o.push(R),e==null||e.advance(1)}if(o.length===0)return e==null||e.finish(),{type:"success",publishedCount:0};let p=new Map;for(let u of o){let h=u.vpsConfig.id,k=p.get(h);k?k.push(u):p.set(h,[u])}let d=0;try{for(let u of p.values())await this.uploaderPort.uploadNotes(u),d+=u.length;return e==null||e.finish(),{type:"success",publishedCount:d}}catch(u){return e==null||e.finish(),{type:"error",error:u}}}slugify(t){if(!t)return"";let e=t.trim().split("/").slice(0,-1).join("/");return e?e.split("/").filter(Boolean).map(r=>r.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s{2,}/g," ").trim().toLowerCase().replace(/\s/g,"-")).join("/"):""}};var Ee=(0,mt.promisify)(ft.readFile),Bt={vpsConfigs:[],folders:[],ignoreRules:[],locale:"system",assetsFolder:"assets",enableAssetsVaultFallback:!0};function ht(i){return JSON.parse(JSON.stringify(i))}function Et(i){let t=ht(i);return Array.isArray(t.vpsConfigs)&&(t.vpsConfigs=t.vpsConfigs.map(e=>({...e,apiKey:lt(e.apiKey)}))),t}function zt(i){let t=ht(i);return Array.isArray(t.vpsConfigs)&&(t.vpsConfigs=t.vpsConfigs.map(e=>({...e,apiKey:ut(e.apiKey)}))),t}function Kt(i){let{vpsConfigs:t,folders:e,ignoreRules:n}=i;return{vpsConfigs:t,folders:e,ignoreRules:n}}var _=class extends f.Plugin{async onload(){await this.loadSettings();let{t}=N(this.app,this.settings);this.addSettingTab(new U(this.app,this)),this.addCommand({id:"publish-to-personal-vps",name:t.plugin.commandPublish,callback:()=>this.publishToSite()}),this.addCommand({id:"test-vps-connection",name:t.plugin.commandTestConnection,callback:()=>this.testConnection()}),this.addCommand({id:"open-vps-settings",name:t.plugin.commandOpenSettings,callback:()=>{this.app.setting.open(),this.app.setting.openTabById(`${this.manifest.id}`)}}),this.addRibbonIcon("rocket",t.plugin.commandPublish,async()=>{try{await this.publishToSite()}catch(e){console.error("[PublishToPersonalVps] Publish failed from ribbon",e),new f.Notice(t.plugin.publishError)}})}async loadSettings(){var s;let t=(s=await this.loadData())!=null?s:{},e=null;try{let r=this.app.vault.adapter,a=`${`.obsidian/plugins/${this.manifest.id}`}/settings.json`;if(await r.exists(a)){let c=await r.read(a);e=JSON.parse(c)}}catch(r){console.warn("[PublishToPersonalVps] Failed to read settings.json snapshot",r)}let n={...Bt,...t,...e};this.settings=zt(n)}async saveSettings(){let t=Et(this.settings);await this.saveData(t)}async publishToSite(){var d,m;let t=this.settings,{t:e}=N(this.app,this.settings);if(!t.vpsConfigs||t.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new f.Notice((m=(d=e.settings.errors)==null?void 0:d.missingVpsConfig)!=null?m:"No VPS configured");return}if(!t.folders||t.folders.length===0){console.warn("[PublishToPersonalVps] No folders configured"),new f.Notice("\u26A0\uFE0F No folders configured for publishing.");return}let n=new K(this.app),s=t.vpsConfigs[0],r=new z(s),o=new X(n,r),a=new j,c=Kt(t),p=await o.execute(c,a);switch(p.type){case"success":new f.Notice(`\u2705 Published ${p.publishedCount} note(s).`);break;case"noConfig":new f.Notice("\u26A0\uFE0F No folders or VPS configured.");break;case"missingVpsConfig":console.warn("[PublishToPersonalVps] Missing VPS for folders:",p.foldersWithoutVps),new f.Notice("\u26A0\uFE0F Some folder(s) have no VPS configured (see console).");break;case"error":console.error(p.error),new f.Notice("\u274C Error during publishing (see console).");break}}async testConnection(){let{t}=N(this.app,this.settings),e=this.settings;if(!(e!=null&&e.vpsConfigs)||e.vpsConfigs.length===0){console.error("[PublishToPersonalVps] No VPS config defined"),new f.Notice(t.settings.errors.missingVpsConfig);return}let n=e.vpsConfigs[0],s=await pt(n);switch(s){case"success":new f.Notice(t.settings.testConnection.success);break;case"failure":new f.Notice(t.settings.testConnection.failed);break;case"unexpected-response":new f.Notice(t.settings.testConnection.unexpectedResponsePrefix+s);break;case"invalid-json":new f.Notice(t.settings.testConnection.invalidJson);break;case"missing-api-key":new f.Notice(t.settings.testConnection.missingApiKey);break;case"invalid-url":new f.Notice(t.settings.testConnection.invalidUrl);break;default:new f.Notice(t.settings.testConnection.resultPrefix+s);break}}};
