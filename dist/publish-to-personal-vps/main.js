/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
"use strict";var ct=Object.create;var F=Object.defineProperty;var gt=Object.getOwnPropertyDescriptor;var dt=Object.getOwnPropertyNames;var ft=Object.getPrototypeOf,ht=Object.prototype.hasOwnProperty;var mt=(s,e)=>{for(var t in e)F(s,t,{get:e[t],enumerable:!0})},et=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of dt(e))!ht.call(s,i)&&i!==t&&F(s,i,{get:()=>e[i],enumerable:!(n=gt(e,i))||n.enumerable});return s};var bt=(s,e,t)=>(t=s!=null?ct(ft(s)):{},et(e||!s||!s.__esModule?F(t,"default",{value:s,enumerable:!0}):t,s)),vt=s=>et(F({},"__esModule",{value:!0}),s);var wt={};mt(wt,{default:()=>J});module.exports=vt(wt);var lt=bt(require("fs"),1),g=require("obsidian"),pt=require("util");var B=class{sanitize(e,t){if(!t)return e;let n=e;if(t.removeFencedCodeBlocks){let i=/^```[^\n]*\n[\s\S]*?^```[ \t]*\n?/gm,a=/^~~~[^\n]*\n[\s\S]*?^~~~[ \t]*\n?/gm;n=n.replace(i,""),n=n.replace(a,"")}return n}sanitizeNote(e,t){let n=this.sanitize(e.content,t);return{...e,content:n}}};var E=class{constructor(e,t,n=new B){this.vaultPort=e;this.uploaderPort=t;this.contentSanitizer=n}async execute(e,t){var u,b;if(!((u=e==null?void 0:e.vpsConfigs)!=null&&u.length)||!((b=e==null?void 0:e.folders)!=null&&b.length))return{type:"noConfig"};let n=[],i=[];for(let l of e.folders){if(!e.vpsConfigs.find(S=>S.id===l.vpsId)){n.push(l.id);continue}let{notes:x}=await this.vaultPort.collectNotesFromFolder(l);for(let S of x)i.push({...S,folder:l})}if(n.length>0)return{type:"missingVpsConfig",foldersWithoutVps:n};let a=i.filter(l=>{var v;return this.shouldKeep(l.frontmatter,(v=e.ignoreRules)!=null?v:null)});if(a.length===0)return t==null||t.start(0),t==null||t.finish(),{type:"success",publishedCount:0};t==null||t.start(a.length);let p=new Map;for(let l of a){let v=e.vpsConfigs.find(D=>D.id===l.folder.vpsId),x={vaultPath:l.vaultPath,relativePath:this.slugify(l.relativePath),content:l.content,frontmatter:l.frontmatter,folderConfig:l.folder,vpsConfig:v},S=this.contentSanitizer.sanitizeNote(x,l.folder.sanitization),C=v.id,V=p.get(C);V||(V={vpsId:C,notes:[]},p.set(C,V)),V.notes.push(S)}let r=0;try{for(let{notes:l}of p.values())await this.uploaderPort.uploadNotes(l),r+=l.length,t==null||t.advance(l.length);return t==null||t.finish(),{type:"success",publishedCount:r}}catch(l){return t==null||t.finish(),{type:"error",error:l}}}shouldKeep(e,t){var n;if(!t||t.length===0)return!0;for(let i of t){let a=e==null?void 0:e[i.property];if(typeof i.ignoreIf=="boolean"&&a===i.ignoreIf||(n=i.ignoreValues)!=null&&n.length&&i.ignoreValues.some(p=>p===a))return!1}return!0}slugify(e){return e?(e=e.trim().split("/").slice(0,-1).join("/"),e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9\s/]/g,"").replace(/\s{2,}/g," ").toLowerCase().replace(/\s/g,"-"),e):""}};var nt={plugin:{name:"Publish To Personal VPS",commandPublish:"Launch publishing to Personal VPS",publishSuccess:"Publishing completed.",publishError:"Error during publishing (see console).",noConfig:"No VPS or folder configuration defined.",error:{failureToExportSettings:"Failed to export settings."}},settings:{tabTitle:"Publish To Personal VPS",errors:{missingVpsConfig:"VPS configuration not found for folder: "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"draft",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"Language selection",label:"Language",description:"Choose plugin language."},vps:{title:"VPS configuration",nameLabel:"Name",nameDescription:"Internal name for this VPS.",urlLabel:"URL",urlDescription:"Example: https://notes.mydomain.com",apiKeyLabel:"API key",apiKeyDescription:"Key used to authenticate uploads.",help:"HTTP requests to /api/upload will use this URL and API key."},folders:{title:"Folders to publish",addButton:"Add folder",deleteButton:"Delete folder",deleteLastForbidden:"At least one folder is required.",vaultLabel:"Vault folder",vaultDescription:"Example: Blog, Notes/Docs, etc.",routeLabel:"Site route",routeDescription:"Example: /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Remove fenced code blocks",sanitizeRemoveCodeBlocksDescription:"If enabled, fenced code blocks (``` or ~~~) will be removed from the content before publishing.",rulesHelp:"Notes whose frontmatter matches the ignore rules below will not be published."},ignoreRules:{title:"Ignore rules",description:"Notes with these frontmatter properties will be ignored during publishing.",help:"You can define global rules based on frontmatter properties and values.",addButton:"Add ignore rule",deleteButton:"Delete ignore rule",propertyLabel:"Frontmatter property",propertyDescription:"Property to inspect in the frontmatter.",valueLabel:"Value(s) to ignore",valueDescription:"Comma-separated list of values to ignore for this property.",modeValues:"Ignore specific values",modeBoolean:"Ignore if equal (true/false)"},testConnection:{label:"Test connection",notImplemented:"Connection test not implemented yet.",failed:"Connection test failed.",success:"Connection test succeeded.",invalidConfig:"Invalid VPS configuration.",invalidJson:"Invalid JSON response.",missingApiKey:"Missing API key.",invalidUrl:"Invalid URL.",resultPrefix:"Test connection result: ",unexpectedResponsePrefix:"Unexpected response from server: "}}},it={plugin:{name:"Publier vers mon VPS personnel",commandPublish:"Publier vers mon VPS personnel",publishSuccess:"Publication termin\xE9e.",publishError:"Erreur lors de la publication (voir la console).",noConfig:"Aucune configuration VPS ou dossier d\xE9finie.",error:{failureToExportSettings:"\xC9chec de l\u2019exportation des param\xE8tres."}},settings:{tabTitle:"Publier vers mon VPS personnel",errors:{missingVpsConfig:"Configuration VPS introuvable pour le dossier : "},defaults:{ignoreRules:{publishingProperty:"publish",nonPublishingValue:"false",draftProperty:"brouillon",draftValue:"true",typeProperty:"type",typeValue:"Dashboard"}},language:{title:"S\xE9lection de la langue",label:"Langue",description:"Choisir la langue du plugin."},vps:{title:"Configuration du VPS",nameLabel:"Nom",nameDescription:"Nom interne pour ce VPS.",urlLabel:"URL",urlDescription:"Ex : https://notes.mondomaine.fr",apiKeyLabel:"Cl\xE9 API",apiKeyDescription:"Cl\xE9 utilis\xE9e pour authentifier les envois.",help:"Les requ\xEAtes HTTP vers /api/upload utiliseront cette URL et cette cl\xE9."},folders:{title:"Dossiers \xE0 publier",addButton:"Ajouter un dossier",deleteButton:"Supprimer le dossier",deleteLastForbidden:"Au moins un dossier est requis.",vaultLabel:"Dossier du vault",vaultDescription:"Ex : Blog, Notes/Docs, etc.",routeLabel:"Route du site",routeDescription:"Ex : /blog, /docs, etc.",sanitizeRemoveCodeBlocksLabel:"Supprimer les blocs de code d\xE9limit\xE9s",sanitizeRemoveCodeBlocksDescription:"Si activ\xE9, les blocs de code d\xE9limit\xE9s (``` ou ~~~) seront supprim\xE9s du contenu avant publication.",rulesHelp:"Les notes dont le frontmatter correspond aux r\xE8gles ci-dessous ne seront pas publi\xE9es."},ignoreRules:{title:"R\xE8gles d\u2019ignorance",description:"Les notes avec ces propri\xE9t\xE9s de frontmatter seront ignor\xE9es lors de la publication.",help:"Vous pouvez d\xE9finir des r\xE8gles globales bas\xE9es sur les propri\xE9t\xE9s et valeurs du frontmatter.",addButton:"Ajouter une r\xE8gle d'ignorance",deleteButton:"Supprimer la r\xE8gle d'ignorance",propertyLabel:"Propri\xE9t\xE9 du frontmatter",propertyDescription:"Propri\xE9t\xE9 \xE0 inspecter dans le frontmatter.",valueLabel:"Valeur(s) \xE0 ignorer",valueDescription:"Liste de valeurs \xE0 ignorer pour cette propri\xE9t\xE9 (s\xE9par\xE9es par des virgules).",modeValues:"Ignorer des valeurs sp\xE9cifiques",modeBoolean:"Ignorer si \xE9gal (true/false)"},testConnection:{label:"Tester la connexion",notImplemented:"Test de connexion non impl\xE9ment\xE9 pour l\u2019instant.",failed:"\xC9chec du test de connexion.",success:"Test de connexion r\xE9ussi.",invalidConfig:"Configuration VPS invalide.",invalidJson:"R\xE9ponse JSON invalide.",missingApiKey:"Cl\xE9 API manquante.",invalidUrl:"URL invalide.",resultPrefix:"R\xE9sultat du test de connexion : ",unexpectedResponsePrefix:"R\xE9ponse inattendue du serveur : "}}};function yt(s){let e=navigator.language||navigator.userLanguage||"en";return String(e).toLowerCase().startsWith("fr")?"fr":"en"}function N(s,e){let t;return!e||e.locale==="system"||!e.locale?t=yt(s):t=e.locale,{locale:t,t:t==="fr"?it:nt}}var G="enc:";function st(s){if(!s)return"";try{return G+btoa(s)}catch(e){return s}}function ot(s){if(!s)return"";if(!s.startsWith(G))return s;let e=s.slice(G.length);try{return atob(e)}catch(t){return""}}var rt=require("obsidian"),z=class{constructor(e){this.vpsConfig=e}async uploadNotes(e){var u;if(!Array.isArray(e)||e.length===0)return;let t=(u=e[0].vpsConfig)!=null?u:this.vpsConfig,n=t.apiKey,a={notes:e.map(b=>this.buildApiNote(b))},p=await(0,rt.requestUrl)({url:t.url.replace(/\/$/,"")+"/api/upload",method:"POST",headers:{"Content-Type":"application/json","x-api-key":n},body:JSON.stringify(a)});if(p.status<200||p.status>=300)throw new Error(`Upload failed with status ${p.status}: ${p.text}`);let r=p.json;if(!r||r.ok!==!0)throw new Error(`Upload API returned an error: ${JSON.stringify(r)}`)}buildApiNote(e){var l,v,x,S,C,V,D,M,T,q,k,R,L;let t=(l=e.frontmatter)!=null?l:{},n=(x=(v=t.slug)!=null?v:t.title)!=null?x:this.extractFileNameWithoutExt(e.vaultPath),i=this.slugify(n),a=((C=(S=e.folderConfig)==null?void 0:S.routeBase)!=null?C:"").replace(/\/+$/,""),p=`${a||""}/${e.relativePath}/${i}`.replace(/\/{2,}/g,"/");p.startsWith("/")||(p=`/${p}`);let r=new Date().toISOString(),u=(D=(V=this.toIsoString(t.publishedAt))!=null?V:this.toIsoString(t.date))!=null?D:r,b=(M=this.toIsoString(t.updatedAt))!=null?M:u;return{id:(q=(T=e.relativePath)!=null?T:e.vaultPath)!=null?q:p,slug:i,route:p,relativePath:e.relativePath,vaultPath:e.vaultPath,markdown:e.content,frontmatter:{title:(k=t.title)!=null?k:n,description:(R=t.description)!=null?R:"",date:(L=this.toIsoString(t.date))!=null?L:u,tags:this.toStringArray(t.tags)},publishedAt:u,updatedAt:b}}extractFileNameWithoutExt(e){var n;return((n=e.split("/").pop())!=null?n:e).replace(/\.[^/.]+$/,"")}slugify(e){return e.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").trim()}toIsoString(e){if(!e)return null;if(e instanceof Date)return isNaN(e.getTime())?null:e.toISOString();if(typeof e=="string"){let t=new Date(e);return isNaN(t.getTime())?null:t.toISOString()}if(typeof e.toISOString=="function")try{let t=e.toISOString(),n=new Date(t);return isNaN(n.getTime())?null:n.toISOString()}catch(t){return null}return null}toStringArray(e){return e?Array.isArray(e)?e.map(t=>typeof t=="string"?t:String(t)).map(t=>t.trim()).filter(Boolean):typeof e=="string"?e.split(",").map(t=>t.trim()).filter(Boolean):[]:[]}};var $=require("obsidian"),K=class{constructor(e){this.app=e}async collectNotesFromFolder(e){var p;let t=[],n=(p=e.vaultFolder)==null?void 0:p.trim();if(!n)return{notes:t};let i=this.app.vault.getAbstractFileByPath(n);if(!i)return{notes:t};let a=async r=>{var u;if(r instanceof $.TFolder)for(let b of r.children)await a(b);else if(r instanceof $.TFile){if((r.extension||"").toLowerCase()!=="md")return;let b=await this.app.vault.read(r),l=this.app.metadataCache.getFileCache(r),v=(u=l==null?void 0:l.frontmatter)!=null?u:{};t.push({vaultPath:r.path,relativePath:this.computeRelative(r.path,n),content:b,frontmatter:v})}};return await a(i),{notes:t}}computeRelative(e,t){if(!t)return e;if(e.startsWith(t)){let n=e.slice(t.length);return n=n.replace(/^\/+/,""),n.length>0?n:""}return e}};var m=require("obsidian");function X(s,e={}){return{...{id:`folder-${Date.now()}`,vaultFolder:"",routeBase:"",vpsId:s,sanitization:{removeFencedCodeBlocks:!0}},...e}}var O=require("obsidian"),U=class extends O.AbstractInputSuggest{constructor(t,n){super(t,n);this.inputEl=n}getSuggestions(t){let n=t.toLowerCase(),i=[];return this.app.vault.getAllLoadedFiles().forEach(a=>{a instanceof O.TFolder&&(!n||a.path.toLowerCase().contains(n))&&i.push(a)}),i}renderSuggestion(t,n){n.setText(t.path)}selectSuggestion(t){this.inputEl.value=t.path,this.inputEl.dispatchEvent(new Event("input")),this.close()}};var j=class extends m.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var R,L,Y,Z,_;let{containerEl:e}=this;e.empty();let{t}=N(this.app,this.plugin.settings),n=this.plugin.settings,i=e.createDiv({cls:"publish-to-personal-vps-settings"});i.createEl("h1",{text:t.settings.tabTitle});let p=i.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});p.createEl("h6",{text:t.settings.language.title}),new m.Setting(p).setName(t.settings.language.label).setDesc(t.settings.language.description).addDropdown(o=>{var c;o.addOption("system","System / Syst\xE8me").addOption("en","English").addOption("fr","Fran\xE7ais").setValue((c=n.locale)!=null?c:"system").onChange(async d=>{n.locale=d,await this.plugin.saveSettings(),this.display()})});let r=(R=n.vpsConfigs)==null?void 0:R[0];r||(r={id:"default",name:"VPS",url:"",apiKey:""},n.vpsConfigs=[r]);let u=i.createDiv({cls:"ptpv-block"}),b=u.createDiv({cls:"ptpv-block-title"});b.createEl("h6",{text:t.settings.vps.title}),new m.Setting(b).setName(t.settings.vps.nameLabel).setDesc(t.settings.vps.nameDescription).addText(o=>o.setPlaceholder("VPS").setValue(r.name).onChange(async c=>{r.name=c.trim(),await this.plugin.saveSettings()})),new m.Setting(u).setName(t.settings.vps.urlLabel).setDesc(t.settings.vps.urlDescription).addText(o=>o.setPlaceholder("https://...").setValue(r.url).onChange(async c=>{r.url=c.trim(),await this.plugin.saveSettings()})),new m.Setting(u).setName(t.settings.vps.apiKeyLabel).setDesc(t.settings.vps.apiKeyDescription).addText(o=>o.setPlaceholder("********").setValue(r.apiKey).onChange(async c=>{r.apiKey=c.trim(),await this.plugin.saveSettings()})),u.createDiv({cls:"ptpv-help",text:t.settings.vps.help});let l=i.createDiv({cls:"ptpv-block"});l.createDiv({cls:"ptpv-block-title"}).createEl("h6",{text:t.settings.ignoreRules.title}),((L=n.ignoreRules)!=null?L:[]).forEach((o,c)=>{var W;let d=new m.Setting(l).setName(`${(W=t.settings.ignoreRules.valueLabel)!=null?W:"Ignore rule"} #${c+1}`);d.addText(P=>{var f;return P.setPlaceholder("frontmatter property").setValue((f=o.property)!=null?f:"").onChange(async y=>{o.property=y.trim(),await this.plugin.saveSettings()})});let A=o.ignoreValues&&o.ignoreValues.length>0?"values":"boolean";d.addDropdown(P=>{var f,y;return P.addOption("boolean",(f=t.settings.ignoreRules.modeBoolean)!=null?f:"Ignore if equals").addOption("values",(y=t.settings.ignoreRules.modeValues)!=null?y:"Ignore specific values").setValue(A).onChange(async h=>{h==="boolean"?(o.ignoreValues=void 0,typeof o.ignoreIf!="boolean"&&(o.ignoreIf=!0)):(o.ignoreIf=void 0,o.ignoreValues||(o.ignoreValues=["draft"])),await this.plugin.saveSettings(),this.display()})}),A==="boolean"?d.addDropdown(P=>P.addOption("true","true").addOption("false","false").setValue(o.ignoreIf===!1?"false":"true").onChange(async f=>{o.ignoreIf=f==="true",await this.plugin.saveSettings()})):d.addText(P=>{var f;return P.setPlaceholder("val1, val2, val3").setValue(((f=o.ignoreValues)!=null?f:[]).join(", ")).onChange(async y=>{o.ignoreValues=y.split(",").map(h=>h.trim()).filter(h=>h.length>0),await this.plugin.saveSettings()})}),d.addExtraButton(P=>{var f;return P.setIcon("trash").setTooltip((f=t.settings.ignoreRules.deleteButton)!=null?f:"Delete ignore rule").onClick(async()=>{var y;(y=n.ignoreRules)==null||y.splice(c,1),await this.plugin.saveSettings(),this.display()})})});let C=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(Y=t.settings.ignoreRules.addButton)!=null?Y:"Add ignore rule"});C.addClass("mod-cta"),C.onclick=async()=>{var c;let o=(c=n.ignoreRules)!=null?c:[];o.push({property:"publish",ignoreIf:!1}),n.ignoreRules=o,await this.plugin.saveSettings(),this.display()};let D=i.createDiv({cls:"ptpv-block"}).createDiv({cls:"ptpv-block-title"});D.createEl("h6",{text:t.settings.folders.title}),Array.isArray(n.folders)||(n.folders=[]),n.folders.length===0&&n.folders.push(X(r.id)),n.folders.forEach((o,c)=>{var y;let d=D.createEl("fieldset",{cls:"ptpv-folder"});d.createEl("legend",{text:o.vaultFolder&&o.vaultFolder.length>0?o.vaultFolder:`${t.settings.folders.vaultLabel} #${c+1}`}),new m.Setting(d).setName((y=t.settings.folders.deleteButton)!=null?y:"Delete folder").addButton(h=>{h.setIcon("trash").onClick(async()=>{var w;if(this.plugin.settings.folders.length<=1){new m.Notice((w=t.settings.folders.deleteLastForbidden)!=null?w:"At least one folder is required.");return}this.plugin.settings.folders.splice(c,1),await this.plugin.saveSettings(),this.display()})}),new m.Setting(d).setName(t.settings.folders.vaultLabel).setDesc(t.settings.folders.vaultDescription).addText(h=>{h.setPlaceholder("Blog").setValue(o.vaultFolder).onChange(async w=>{o.vaultFolder=w.trim(),await this.plugin.saveSettings()}),new U(this.app,h.inputEl)}),new m.Setting(d).setName(t.settings.folders.routeLabel).setDesc(t.settings.folders.routeDescription).addText(h=>h.setPlaceholder("/blog").setValue(o.routeBase).onChange(async w=>{o.routeBase=w.trim(),await this.plugin.saveSettings()})),new m.Setting(d).setName(t.settings.folders.sanitizeRemoveCodeBlocksLabel).setDesc(t.settings.folders.sanitizeRemoveCodeBlocksDescription).addToggle(h=>{var w,Q;return h.setValue((Q=(w=o.sanitization)==null?void 0:w.removeFencedCodeBlocks)!=null?Q:!0).onChange(async tt=>{o.sanitization?o.sanitization.removeFencedCodeBlocks=tt:o.sanitization={removeFencedCodeBlocks:tt},await this.plugin.saveSettings()})})});let T=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(Z=t.settings.folders.addButton)!=null?Z:"Add folder"});T.addClass("mod-cta"),T.onclick=async()=>{var c,d,A;let o=(A=(d=(c=n.vpsConfigs)==null?void 0:c[0])==null?void 0:d.id)!=null?A:"default";this.plugin.settings.folders.push(X(o)),await this.plugin.saveSettings(),this.display()};let k=i.createDiv({cls:"ptpv-button-row"}).createEl("button",{text:(_=t.settings.testConnection.label)!=null?_:"Test connection"});k.addClass("mod-cta"),k.onclick=async()=>{try{await this.plugin.testConnection()}catch(o){console.error("[PublishToPersonalVps] Connection test failed",o)}}}};async function at(s){var a;let e=((a=s.url)!=null?a:"").trim();if(!e)return"invalid-url";if(!s.apiKey)return"missing-api-key";let t=`${e.replace(/\/$/,"")}/api/ping`,n=await fetch(t,{method:"GET",headers:{"x-api-key":s.apiKey}});if(!n.ok)return`HTTP ${n.status}`;let i=null;try{i=await n.json()}catch(p){return"invalid-json"}return!i||i.ok!==!0?"unexpected-response":"success"}var I=require("obsidian"),H=class{constructor(){this.notice=null;this.total=0;this.current=0;this.lastPct=-1}start(e){this.total=Math.max(1,e),this.current=0,this.notice=new I.Notice(this.format(),0),this.update()}advance(e=1){this.current=Math.min(this.total,this.current+e),this.update()}finish(){var e,t;try{(t=(e=this.notice)==null?void 0:e.hide)==null||t.call(e)}catch(n){}this.notice=null,this.total>0&&this.current===this.total?new I.Notice("\u2705 Upload completed"):new I.Notice("\u26A0\uFE0F Upload ended prematurely")}format(){let e=Math.floor(this.current/this.total*100);return`Uploading notes\u2026 ${this.current}/${this.total} (${e}%)`}update(){let e=Math.floor(this.current/this.total*100);if(e===this.lastPct&&this.current!==this.total)return;this.lastPct=e;let t=this.format(),n=this.notice;n&&typeof n.setMessage=="function"?n.setMessage(t):new I.Notice(t,1500)}};var ee=(0,pt.promisify)(lt.readFile),Pt={vpsConfigs:[],folders:[],locale:"system"};function ut(s){return JSON.parse(JSON.stringify(s))}function St(s){let e=ut(s);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:st(t.apiKey)}))),e}function Ct(s){let e=ut(s);return Array.isArray(e.vpsConfigs)&&(e.vpsConfigs=e.vpsConfigs.map(t=>({...t,apiKey:ot(t.apiKey)}))),e}var J=class extends g.Plugin{async onload(){await this.loadSettings();let{t:e}=N(this.app,this.settings);this.addSettingTab(new j(this.app,this)),this.addCommand({id:"publish-to-personal-vps",name:e.plugin.commandPublish,callback:()=>this.publishAll()}),this.addCommand({id:"test-vps-connection",name:"Test VPS connection",callback:()=>this.testConnection()}),this.addCommand({id:"open-vps-settings",name:"Open VPS Settings",callback:()=>{this.app.setting.open(),this.app.setting.openTabById(`${this.manifest.id}`)}}),this.addRibbonIcon("rocket",e.plugin.commandPublish,async()=>{try{await this.publishAll()}catch(t){console.error("[PublishToPersonalVps] Publish failed from ribbon",t),new g.Notice(e.plugin.publishError)}})}async loadSettings(){var i;let e=(i=await this.loadData())!=null?i:{},t=null;try{let a=this.app.vault.adapter,r=`${`.obsidian/plugins/${this.manifest.id}`}/settings.json`;if(await a.exists(r)){let u=await a.read(r);t=JSON.parse(u)}}catch(a){console.warn("[PublishToPersonalVps] Failed to read settings.json snapshot",a)}let n={...Pt,...e,...t};this.settings=Ct(n)}async saveSettings(){let e=St(this.settings);await this.saveData(e)}async publishAll(){var u;let e=this.settings,t=new K(this.app),n=(u=e.vpsConfigs)==null?void 0:u[0];if(!n){new g.Notice("No VPS configured");return}let i=new z(n),a=new E(t,i),p=new H,r=await a.execute(e,p);switch(r.type){case"success":new g.Notice(`\u2705 Published ${r.publishedCount} note(s).`);break;case"noConfig":new g.Notice("\u26A0\uFE0F No folders or VPS configured.");break;case"missingVpsConfig":console.warn("Missing VPS for folders:",r.foldersWithoutVps),new g.Notice("\u26A0\uFE0F Some folder(s) have no VPS configured (see console).");break;case"error":console.error(r.error),new g.Notice("\u274C Error during publishing (see console).");break}}async testConnection(){let{t:e}=N(this.app,this.settings),t=this.settings;if(!(t!=null&&t.vpsConfigs)||t.vpsConfigs.length===0){console.error("No VPS config defined"),new g.Notice(e.settings.errors.missingVpsConfig);return}let n=t.vpsConfigs[0],i=await at(n);switch(i){case"success":new g.Notice(e.settings.testConnection.success);break;case"failure":new g.Notice(e.settings.testConnection.failed);break;case"unexpected-response":new g.Notice(e.settings.testConnection.unexpectedResponsePrefix+i);break;case"invalid-json":new g.Notice(e.settings.testConnection.invalidJson);break;case"missing-api-key":new g.Notice(e.settings.testConnection.missingApiKey);break;case"invalid-url":new g.Notice(e.settings.testConnection.invalidUrl);break;default:new g.Notice(e.settings.testConnection.resultPrefix+i);break}}};
